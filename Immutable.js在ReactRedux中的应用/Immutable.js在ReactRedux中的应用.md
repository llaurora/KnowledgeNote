
# Immutable.jsåœ¨React/Reduxä¸­çš„åº”ç”¨

### ç›®å½•
##### &sect; [1.å‡ ä¸ªåœºæ™¯](#some-scence)
##### &sect; [2.ä»€ä¹ˆæ˜¯ Immutable Data](#what-ImmutableData)
##### &sect; [3.Immutable.jsä»‹ç»](#Immutable-introduce)
* [3.1Immutable.js ä¸»è¦çš„ä¸‰å¤§ç‰¹æ€§](#main-feature)
* [3.2Immutable.js ä¼˜ç‚¹](#main-advantage)
* [3.3Immutable.js ç¼ºç‚¹](#main-disadvantage)
* [3.4 Immutable.jsä½¿ç”¨è¿‡ç¨‹ä¸­çš„ä¸€äº›æ³¨æ„ç‚¹](#immutable-notice)
##### &sect; [4.React é»˜è®¤çš„æ¸²æŸ“è¡Œä¸º](#react-render)
* [4.1æ›´æ–°é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸ](#life-cycle)
* [4.2å…³äºshouldComponentUpdate](#about-shouldComponentUpdate)
* [4.3å¸¦å‘çš„ä¸€äº›æ³¨æ„ç‚¹](#focus-point)
##### &sect; [5.Reactå®˜æ–¹çš„è§£å†³æ–¹æ¡ˆ](#react-solve)
* [5.1PureRenderMixin](#PureRenderMixin)
* [5.2pureRender](#pureRender)
* [5.3shallowCompare](#shallowCompare)
* [5.4PureComponent](#PureComponent)
##### &sect; [6.Immutable.jsåœ¨React/Reduxä¸­çš„åº”ç”¨](#Immutable-apply)
* [6.1ä½¿ç”¨ immutable çš„è¾¹ç•Œæ€§é—®é¢˜](#use-boundary)
* [6.2ç”¨immutable.jsæ”¹é€ shouldComponentUpdate](#rebuld-shouldComponentUpdate)
* [6.3ä¸Reduxæ­é…ä½¿ç”¨](#with-redux)

## Â§ <a name="some-scence">1.å‡ ä¸ªåœºæ™¯</a>
#### âŠ™ åœºæ™¯ä¸€ï¼šå…³äºæ•°æ®ä¸å¯å˜
##### ä¾‹1ï¼š
```javascript
 const data={key:"value"};
 func(data);
 console.log(data)//"çŒœçŒœä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ"

//function func(data) {
	//data.key="dataçš„keyè¢«æ”¹å˜äº†"
   //const data1=Object.assign(data,{name:"åå­—"})
//}
```
**ä¸æŸ¥çœ‹funcæ–¹æ³•ï¼Œä¸çŸ¥é“å®ƒå¯¹dataåšäº†ä»€ä¹ˆï¼Œæ— æ³•ç¡®è®¤ä¼šæ‰“å°ä»€ä¹ˆã€‚ä½†å¦‚æœdataæ˜¯Immutableï¼Œä½ å¯ä»¥ç¡®å®šæ‰“å°çš„å°±æ˜¯value**
```javascript
 const data=Immutable.Map({key:"value"});
 func(data);
 console.log(data.get("key"))//æ‰“å°çš„æ˜¯Value
```
##### ä¾‹2ï¼š
```javascript
    const obj1={a:1,b:2,c:{d:3}};
    const obj2=obj1;
    obj2.a=11;
    console.log(obj1.a)//è¾“å‡ºçš„æ˜¯11
```
**è€Œå¦‚æœç”¨Immutable.jsçš„è¯**
```javascript
    const obj1=Immutable.fromJS({a:1,b:2,c:{d:3}});
    const obj2=obj1.merge(obj1);
    obj2=obj2.updateIn(["c","d"],()=>300);
    console.log(obj1.toJS(),obj2.toJS())//{a:1,b:2,c:{d:3}}ï¼Œ{a:1,b:2,c:{d:300}}
```

#### Â§ è§‚åæ„Ÿï¼š
~**é—®ï¼Ÿ** ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸Šé¢è¿™ç§æƒ…å†µ

~**ç­”ï¼š** åœ¨JSä¸­çš„å¼•ç”¨æ•°æ®ç±»å‹ï¼ˆå¦‚Objectï¼ŒArrayç­‰ï¼‰ä½¿ç”¨çš„æ˜¯å¼•ç”¨èµ‹å€¼ï¼Œå¦‚æœæ–°çš„å¯¹è±¡ç®€å•çš„å¼•ç”¨äº†åŸå§‹å¯¹è±¡ï¼Œæ”¹å˜æ–°çš„å¯¹è±¡ä¹Ÿå°†å½±å“æ—§çš„ï¼›
>ä¸å…¶ä»–è¯­è¨€ä¸åŒï¼ŒJSå¼•ç”¨æ•°æ®ç±»å‹ï¼ˆæ¯”å¦‚Objectï¼ŒArrayï¼‰çš„å€¼æ˜¯ä¿å­˜åœ¨å †å†…å­˜ä¸­çš„å¯¹è±¡ã€‚JavaScriptä¸å…è®¸ç›´æ¥è®¿é—®å †å†…å­˜ä¸­çš„ä½ç½®ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ç›´æ¥æ“ä½œå¯¹è±¡çš„å †å†…å­˜ç©ºé—´ã€‚åœ¨æ“ä½œå¯¹è±¡æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨æ“ä½œå¯¹è±¡çš„å¼•ç”¨è€Œä¸æ˜¯å®é™…çš„å¯¹è±¡ï¼ˆå½“å¤åˆ¶ä¿å­˜ç€å¯¹è±¡çš„æŸä¸ªå˜é‡æ—¶ï¼Œæ“ä½œçš„æ˜¯å¯¹è±¡çš„å¼•ç”¨ã€‚ä½†åœ¨ä¸ºå¯¹è±¡æ·»åŠ å±æ€§æ—¶ï¼Œæ“ä½œçš„æ˜¯å®é™…çš„å¯¹è±¡ï¼‰ã€‚å› æ­¤ï¼Œå¼•ç”¨ç±»å‹çš„å€¼éƒ½æ˜¯æŒ‰å¼•ç”¨è®¿é—®çš„ã€‚è¿™é‡Œçš„å¼•ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç²—æµ…åœ°ç†è§£ä¸ºä¿å­˜åœ¨å˜é‡å¯¹è±¡ä¸­çš„ä¸€ä¸ªåœ°å€ï¼Œè¯¥åœ°å€ä¸å †å†…å­˜çš„å®é™…å€¼ç›¸å…³è”ã€‚å½“æˆ‘ä»¬è¦è®¿é—®å †å†…å­˜ä¸­çš„å¼•ç”¨æ•°æ®ç±»å‹æ—¶ï¼Œå®é™…ä¸Šæˆ‘ä»¬é¦–å…ˆæ˜¯ä»å˜é‡å¯¹è±¡ä¸­è·å–äº†è¯¥å¯¹è±¡çš„åœ°å€å¼•ç”¨ï¼ˆæˆ–è€…åœ°å€æŒ‡é’ˆï¼‰ï¼Œç„¶åå†ä»å †å†…å­˜ä¸­å–å¾—æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚

![jsAssign1](assets/jsAssign1.png)

* const m={a:10,b:20}åœ¨è¿›è¡Œ"="èµ‹å€¼çš„æ—¶å€™æ˜¯æŠŠå­˜æ”¾äºæ ˆé‡Œé¢çš„æ ‡è¯†ç¬¦obj1é€šè¿‡å¼•ç”¨æŒ‡é’ˆæŒ‡å‘äº†å­˜æ”¾äºå †é‡Œé¢çš„{a:10,b:2};
* å½“const n=mçš„æ—¶å€™åªæ˜¯èµ‹äºˆnä¸€ä¸ªæ–°çš„å†…å­˜åœ°å€ï¼Œä½†è¿™ä¸ªæ–°çš„å†…å­˜åœ°å€æŒ‡å‘çš„è¿˜æ˜¯å­˜æ”¾äºå †é‡Œé¢çš„åŒä¸€ä¸ª{a:10,b:2};
* æ‰€ä»¥å½“æ›´æ”¹nçš„aå±æ€§çš„æ—¶å€™ï¼ˆn.a=100ï¼‰ï¼Œè¾“å‡ºçš„mçš„aå±æ€§ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–

![jsAssign2](assets/jsAssign2.png)

JSä¸­çš„å¼•ç”¨æ•°æ®ç±»å‹è‡ªç„¶ä¹Ÿæœ‰ä¼˜ç‚¹ï¼Œä¼˜ç‚¹åœ¨äºé¢‘ç¹çš„æ“ä½œæ•°æ®éƒ½æ˜¯åœ¨åŸå¯¹è±¡çš„åŸºç¡€ä¸Šä¿®æ”¹ï¼Œä¸ä¼šåˆ›å»ºæ–°å¯¹è±¡ï¼Œä»è€Œå¯ä»¥æœ‰æ•ˆçš„åˆ©ç”¨å†…å­˜ï¼Œä¸ä¼šæµªè´¹å†…å­˜ï¼Œè¿™ç§ç‰¹æ€§ç§°ä¸º**mutable**ï¼ˆå¯å˜ï¼‰ï¼Œä½†æ°æ°å®ƒçš„ä¼˜ç‚¹ä¹Ÿæ˜¯å®ƒçš„ç¼ºç‚¹ï¼Œå¤ªè¿‡äºçµæ´»å¤šå˜åœ¨å¤æ‚æ•°æ®çš„åœºæ™¯ä¸‹ä¹Ÿé€ æˆäº†å®ƒçš„ä¸å¯æ§æ€§ï¼Œå‡è®¾ä¸€ä¸ªå¯¹è±¡åœ¨å¤šå¤„ç”¨åˆ°ï¼Œåœ¨æŸä¸€å¤„ä¸å°å¿ƒä¿®æ”¹äº†æ•°æ®ï¼Œå…¶ä»–åœ°æ–¹å¾ˆéš¾é¢„è§åˆ°æ•°æ®æ˜¯å¦‚ä½•æ”¹å˜çš„

~**æå‡ºè§£å†³æ–¹æ¡ˆï¼š** é’ˆå¯¹ä¸Šé¢è¿™äº›æƒ…å†µï¼Œä¼šæƒ³ç€æ•°æ®è¦æ˜¯ä¸å¯å˜å°±å¥½äº†ï¼ˆå¯¹è±¡bæ¥æº(Copy)äºå¯¹è±¡aï¼Œä½†aå’Œbçš„æ“ä½œäº’ä¸å½±å“ï¼Œæ•°æ®å¯æ§ï¼‰ã€‚ï¼ˆåœ¨â€œåœºæ™¯äºŒâ€é‡Œé¢å†ç»“åˆè¡¥å……â€œå¼•ç”¨æ•°æ®ç±»å‹èµ‹å€¼(=)å’Œæµ…æ‹·è´çš„åŒºåˆ«â€ï¼‰

*  ä¸€ï¼šä¼šæƒ³åˆ°es6çš„`object.assign()`æˆ–è€…Restå‚æ•°(...)ï¼›const obj1={a:1};const obj2=object.assign({},obj1);console.log(obj1.a)//è¿™å„¿è¾“å‡ºçš„æ˜¯1`ï¼Œå’‹çœ‹ä¹‹ä¸‹ä»¥ä¸º`object.assign()`æ˜¯æ·±æ‹·è´,ä½†å…¶å®`object.assign()`å±äºä¼ªæ·±æ‹·è´ï¼›`Restå‚æ•°`å’Œ`object.assign()`ä¸€æ ·å±äºä¼ªæ·±æ‹·è´ï¼›
>Object.assign()å±äºä¼ªæ·±æ‹·è´ï¼ˆç¬¬ä¸€å±‚çš„æ·±æ‹·è´ï¼ŒåµŒå¥—å±‚çš„æµ…æ‹·è´ï¼‰
```javascript
const obj1={
    a:1,
    b:2,
    c:{
        d:3
    }
   };
 const obj2=Object.assign({},obj1);
 obj2.a=11;
 console.log(obj1.a); //è¾“å‡ºçš„è¿˜æ˜¯1ï¼Œç¬¬ä¸€å±‚æ·±æ‹·è´
```
```javascript
const obj1={
    a:1,
    b:2,
    c:{
        d:3
    }
   };
 const obj2=Object.assign({},obj1);
 obj2.c={f:4};
 console.log(obj1.c); //è¾“å‡ºçš„è¿˜æ˜¯{d:3}ï¼Œç¬¬ä¸€å±‚æ·±æ‹·è´
```
```javascript
const obj1={
  a:1,
  b:2,
  c:{
      d:3
     }
   };
 const obj2=Object.assign({},obj1);
 obj2.c.d=44;
 console.log(obj1.c.d); //è¾“å‡ºçš„æ˜¯44è€Œä¸æ˜¯3ï¼ŒåµŒå¥—å±‚æ˜¯æµ…æ‹·è´
```
```javascript
const obj1={
    a:1,
    b:2,
    c:{
        d:3
    }
};
const obj2=Object.assign({},obj1);
obj2.a=11;
obj2.c.d=44;
console.log(obj1,obj2); //è¾“å‡ºçš„æ˜¯{a:1,b:2,c:{d:44}}ï¼Œ{a:11,b:2,c:{d:44}}
```
```javascript
const m={a:1,b:2,c:{d:3}};
const n={...m};
n.c.d=300;
console.log(m.c.d) //è¾“å‡ºçš„æ˜¯300
```
* äºŒï¼šä¼šæƒ³åˆ°ç”¨æ·±æ‹·è´ï¼Œæ·±æ‹·è´ç¡®å®æ˜¯èƒ½è§£å†³ä¸Šé¢è¿™äº›æƒ…å†µï¼Œç„¶è€Œæ·±æ‹·è´çš„å‡ ç§æ–¹æ³•ï¼šå¤§è‡´åŸç†ä¸ºæ ˆé‡Œæ–°çš„æ ‡å¿—ç¬¦é€šè¿‡æ–°çš„å†…å­˜åœ°å€å¯¹å­˜æ”¾äºå †é‡Œçš„å¯¹è±¡(å¼•ç”¨æ•°æ®ç±»å‹çš„å€¼)å¾ªç¯éå†ååœ¨å †é‡Œ**é‡æ–°ç»™å¼€è¾Ÿçš„ä¸€å—å„¿å†…å­˜**è¿›è¡Œå¼•ç”¨ï¼›

~**æŠ›å‡ºè®¾æƒ³ï¼Ÿï¼š**æœ‰æ²¡æœ‰æ—¢èƒ½ä¿æŒæ•°æ®çš„ä¸å¯å˜ï¼Œä½†åˆèƒ½é¿å…ä½¿ç”¨ deepCopyï¼ˆæ·±æ‹·è´ï¼‰è€Œé€ æˆçš„ CPU å’Œå†…å­˜çš„æµªè´¹ï¼ˆ*è™½ç„¶å¤§æ¦‚çŸ¥é“äº†å¯ä»¥ç”¨Immutableï¼Œå§‘ä¸”ä¿ç•™è¿™ä¸ªè®¾æƒ³åœ¨è¿™å„¿ï¼Œåé¢ä¼šè®²ä¸ºå•¥å¯ä»¥ç”¨Immutable*ï¼‰ï¼Ÿ

#### âŠ™ åœºæ™¯äºŒï¼šå…³äº"==="æ¯”è¾ƒ
> åœ¨ä¸å°‘æ—¶å€™ï¼Œæˆ‘ä»¬å…¶å®éœ€è¦æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦"ç›¸ç­‰"çš„ï¼ˆ{a:1,b:2}==={a:1,b:2}ï¼‰ï¼Œæ¯”å¦‚åœ¨Reactä¸­æˆ‘ä»¬å¯ä»¥åœ¨ç»„ä»¶shouldComponentUpdateæ–¹æ³•ä¸­åœ¨æ¥æ”¶åˆ°æ–°çš„props æˆ–è€… stateï¼Œæ¯”è¾ƒæ–°æ—§propsæˆ–è€…stateçš„å€¼æ˜¯å¦ç›¸åŒè€Œå¯¹ç»„ä»¶æ˜¯å¦è¿›è¡Œé‡æ–°æ¸²æŸ“è¿›è¡Œæ§åˆ¶ï¼Œå…¶å®è¿™ä¹Ÿæ˜¯Reactæ€§èƒ½ä¼˜åŒ–çš„å…³é”®

##### ä¾‹ï¼š
```javascript
{a:1,b:2,c:3}==={a:1,b:2,c:3}; // false
[1,2,3] === [1,2,3]; // false
```
å°±å¦‚ä¸Šé¢è¿™æ ·çš„ä¾‹å­ï¼Œæˆ‘ä»¬å…¶å®æ˜¯æƒ³ç€å·¦å³å®Œå…¨ç›¸åŒï¼Œæƒ³è¿”å›çš„æ˜¯ä¸€ä¸ªtrueï¼›è‡³äºåŸå› ï¼Œå¯¹äºJSå¼•ç”¨æ•°æ®ç±»å‹çš„===æ¯”è¾ƒï¼Œæ¯”è¾ƒçš„æ˜¯**å…¶å¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡**ï¼ˆåœ¨è®¡ç®—æœºç§‘å­¦ä¸­, å¯¹è±¡æ˜¯æŒ‡å†…å­˜ä¸­çš„å¯ä»¥è¢« [æ ‡è¯†ç¬¦](https://developer.mozilla.org/en-US/docs/Glossary/Identifier)å¼•ç”¨çš„ä¸€å—åŒºåŸŸï¼‰ï¼›

```javascript
const obj1={a:1};
const obj2=obj1;
const obj3={a:1};
obj2.a=100;
console.log(obj1===obj2);//è¾“å‡ºçš„æ˜¯trueï¼ˆobj1å’Œpbj2æŒ‡å‘äºå †ä¸­çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ä¸ºtrueï¼‰
console.log(obj1===obj3);//è¾“å‡ºçš„æ˜¯falseï¼ˆobj1å’Œpbj2æŒ‡å‘äºå †ä¸­çš„ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
```

~**æå‡ºè§£å†³æ–¹æ¡ˆï¼š**å¯¹äºä¸Šé¢é‡‡ç”¨deepCopyã€deepCompareæ¥æ¯”è¾ƒï¼Œä½†å…¶å®è¿™ç±»æ¯”è¾ƒçš„å¤§è‡´åŸç†ï¼Œæ˜¯é€šè¿‡å¯¹è¦æ¯”è¾ƒçš„ä¸¤ä¸ªå¯¹è±¡ï¼ˆæˆ–è€…æ•°ç»„ï¼‰è¿›è¡Œå±‚å±‚å¾ªç¯ï¼Œè¿›è€Œå¯¹å„ä¸ªå€¼è¿›è¡Œ"==="æ¯”è¾ƒï¼›ä½†è¿™æ ·æ¯”è¾ƒéº»çƒ¦è€Œä¸”è€—æ€§èƒ½ï¼ˆç›¸å¯¹Immutableè€Œè¨€ï¼Œåé¢ä¼šè®²ä¸ºå•¥ï¼‰

```javascript
//å¦‚åªè€ƒè™‘å¯¹è±¡åªæœ‰ä¸€å±‚ï¼ˆæœ‰å¤šå±‚çš„è¯ï¼Œæ— å¤–ä¹ä¹Ÿæ˜¯å¤šäº†å±‚åˆ¤æ–­ï¼Œç„¶åè¿˜æ˜¯ç”¨åŒæ ·çš„æ–¹å¼è¿›è¡Œ===æ¯”è¾ƒï¼‰
function isEqual(a,b) {
       let result=true;
       for (let key in a){
           if(!b[key] || a[key]!==b[key]){
               result=false
           }
       }
       return result
   }
const obj1={a:1,b:2,c:3};
const obj2={a:1,b:2,c:3};
console.log(isEqual(obj1,obj2)) //è¾“å‡ºçš„æ˜¯true
```
æš‚ä¸”å…ˆä¸è®ºè¿™å„¿ä¸ºå•¥é‡‡ç”¨immutable.jsï¼Œç”¨immutable.jsçš„è¯ï¼Œ
```javascript
let m=Immutable.fromJS({a:1,b:2,c:{d:3}});
let n=Immutable.fromJS({a:1,b:2,c:{d:3}});
console.log(Immutable.is(m,n)); //è¾“å‡ºtrueï¼ˆé€šè¿‡hashCodeæ¯”è¾ƒå€¼ï¼‰
console.log(m===n); //è¾“å‡ºfalseï¼ˆmå’ŒnæŒ‡å‘äºå †é‡Œçš„å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
```

~**åœ¨è¿™å„¿è¡¥å……è¯´ä¸‹ï¼š**å¼•ç”¨æ•°æ®ç±»å‹èµ‹å€¼(=)ï¼Œæµ…æ‹·è´å’Œæ·±æ‹·è´çš„åŒºåˆ«ï¼š
* å¼•ç”¨æ•°æ®ç±»å‹èµ‹å€¼(=)æ“ä½œï¼ˆconst m={a:10,b:20};let n=m;ï¼‰æ˜¯åœ¨æ ˆé‡Œé¢é‡æ–°ç»™åˆ†é…äº†ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œç„¶åè¿™ä¸ªå†…å­˜åœ°å€æŒ‡å‘äºå †é‡Œé¢çš„å¯¹è±¡å…¶å®è¿˜æ˜¯æ˜¯åŒä¸€ä¸ªï¼
```javascript
const m={a:10,b:20};
const n=m;
n.b=30;
console.log(m===n);//è¾“å‡ºçš„æ˜¯trueï¼ˆmå’ŒnæŒ‡å‘äºå †é‡Œçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºtrueï¼‰
```
![jsAssign2](assets/jsAssign2-7028477.png)

* æµ…æ‹·è´æ˜¯åªå¤åˆ¶å¯¹è±¡ï¼ˆæ¯”å¦‚æœ‰const m={a:10,b:{c:20}}ï¼‰çš„ç¬¬ä¸€å±‚ï¼Œç¬¬ä¸€å±‚çš„æ“ä½œäº’ä¸å½±å“ï¼Œä½†åµŒå¥—å±‚çš„å¼•ç”¨æ•°æ®ç±»å‹æŒ‡å‘çš„è¿˜æ˜¯äºå †ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿˜æ˜¯ä¼šç›¸äº’å½±å“ï¼ŒåƒObject.assign()è¿™ç±»æ–¹æ³•å¦‚æœéè¦ä¸¥æ ¼çš„ç®—æµ…æ‹·è´è¿˜æ˜¯æ·±æ‹·è´ï¼Œå…¶å±äºæµ…æ‹·è´ã€‚

 Object.freeze å’Œ ES6 ä¸­æ–°åŠ å…¥çš„ const éƒ½å¯ä»¥è¾¾åˆ°é˜²æ­¢å¯¹è±¡è¢«ç¯¡æ”¹çš„åŠŸèƒ½ï¼Œä½†å’Œè¿™å„¿è®¨è®ºçš„æ•°æ®å¯æ§ä¸å¤§ç›¸å…³(å¯¹è±¡bæ¥æºäºå¯¹åƒaï¼Œä½†aå’Œbçš„æ“ä½œäº’ä¸å½±å“)ã€‚

```javascript
const m = {a:1,b:{c:2}};
const n = m;
n.a = 100;
console.log(m,n); //è¾“å‡ºaä¸º{a:100,b:{c:2}},bä¸º{a:100,b:{c:2}}
```

**constæœ¬è´¨ï¼š**`const`å®é™…ä¸Šä¿è¯çš„ï¼Œå¹¶ä¸æ˜¯å˜é‡çš„å€¼ä¸å¾—æ”¹åŠ¨ï¼Œè€Œæ˜¯å˜é‡æŒ‡å‘çš„é‚£ä¸ªå†…å­˜åœ°å€æ‰€ä¿å­˜çš„æ•°æ®ä¸å¾—æ”¹åŠ¨ã€‚å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹æ¥è¯´ï¼ˆæ•°å€¼ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ï¼‰ï¼Œå€¼å°±ä¿å­˜åœ¨å˜é‡æŒ‡å‘çš„é‚£ä¸ªæ ˆå†…å­˜åœ°å€ï¼Œå› æ­¤ç­‰åŒäºå¸¸é‡ã€‚ä½†å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹æ¥è¯´ï¼ˆä¸»è¦æ˜¯å¯¹è±¡å’Œæ•°ç»„ï¼‰ï¼Œç”¨èµ‹å€¼æ“ä½œç¬¦"="èµ‹å€¼æ ‡è¯†ç¬¦çš„æ—¶å€™åªæ˜¯èµ‹å€¼ç»™äº†æ ‡è¯†ç¬¦ä¸€ä¸ªæŒ‡å‘å †å†…å­˜ä¸­å®é™…æ•°æ®ä¸€ä¸ªåœ°å€æŒ‡é’ˆï¼Œ`const`åªèƒ½ä¿è¯è¿™ä¸ªæŒ‡é’ˆæ˜¯å›ºå®šçš„ï¼ˆå³æ€»æ˜¯æŒ‡å‘åŒä¸€ä¸ªå›ºå®šçš„å †å†…å­˜åœ°å€ï¼‰ï¼Œè‡³äºå®ƒæŒ‡å‘çš„æ•°æ®ç»“æ„æ˜¯ä¸æ˜¯å¯å˜çš„ï¼Œå°±å®Œå…¨ä¸èƒ½æ§åˆ¶äº†ã€‚å› æ­¤ï¼Œå°†ä¸€ä¸ªå¯¹è±¡å£°æ˜ä¸ºå¸¸é‡å¿…é¡»éå¸¸å°å¿ƒ

```javascript
const foo = {
  name: 'joker',
  age: 20,
};
foo.age = 22; // Okçš„ï¼Œå¯ä»¥æˆåŠŸ
console.log(foo); // {name: "joker", age: 22}

// å°†fooæŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡ï¼Œå°±ä¼šæŠ¥é”™
foo = {}; // Uncaught TypeError: Assignment to constant variable
```

[JSä½œç”¨åŸŸåŠé—­åŒ…]([https://github.com/DlLucky/know-how/blob/master/essay%20note/Js%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%8F%8A%E9%97%AD%E5%8C%85.md](https://github.com/DlLucky/know-how/blob/master/essay note/Jsä½œç”¨åŸŸåŠé—­åŒ….md))

 è€Œåƒä¸Šé¢çš„è¿™ä¸ªå¼•ç”¨æ•°æ®ç±»å‹èµ‹å€¼(=)å……å…¶é‡èƒ½ç®—æ˜¯â€œå¼•ç”¨â€ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„æµ…æ‹·è´ã€‚è€Œæµ…æ‹·è´ä¹‹äºå¼•ç”¨æ•°æ®ç±»å‹èµ‹å€¼(=)çš„ä¸åŒåœ¨äºï¼Œæµ…æ‹·è´çš„å¾—åˆ°çš„å¯¹è±¡å€¼æ˜¯åœ¨å †é‡Œé¢ç»™é‡æ–°ç”Ÿæˆäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå‰åä¸¤ä¸ªå¯¹è±¡å¼•ç”¨çš„å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸¤ç›¸æ¯”è¾ƒçš„è¯ï¼Œè¾“å‡ºçš„ä¼šæ˜¯false;

#####  ä¾‹1ï¼š
```javascript
const m={a: 10, b: 20};
const n=Object.assign({}, m);
console.log(m===n); //è¾“å‡ºçš„æ˜¯falseï¼ˆmå’ŒnæŒ‡å‘äºå †é‡Œçš„å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
```

#####  ä¾‹2ï¼š
```javascript
function shallowCopy(src){
   const target={};
   for (let key in src){
       if(src.hasOwnProperty(key)){
           target[key]=src[key];
       }
   }
   return target;
}

const obj1={
   a:10,
   b:20,
   c:{
       d:30,
       f:40
   }
};
const obj2=obj1;
const obj3=shallowCopy(obj1);

obj2.a=1000;
obj3.b=2000;

obj2.c.d=3000;
obj3.c.f=4000;

console.log(obj1); //{1000,20,c:{d:3000,e:4000}}
console.log(obj2); //{1000,20,c:{d:3000,e:4000}}
console.log(obj3); //{10,2000,c:{d:3000,e:4000}}
```

![shallowCopy](assets/shallowCopy.png)

* æ·±æ‹·è´æ˜¯å¯¹å¯¹è±¡ä»¥åŠå¯¹è±¡çš„æ‰€æœ‰å­å¯¹è±¡è¿›è¡Œæ‹·è´ï¼Œä¸ç®¡æ˜¯åµŒå¥—å±‚ä¸å¦ï¼ŒæŒ‡å‘äºå †ä¸­çš„å¯¹è±¡å¹¶ä¸æ˜¯åŒä¸€ä¸ª

![deepCopy](assets/deepCopy.png)


## Â§ <a name="what-ImmutableData">2.ä»€ä¹ˆæ˜¯ Immutable Data</a>
> Immutable Data å°±æ˜¯ä¸€æ—¦åˆ›å»ºï¼Œå°±ä¸èƒ½å†è¢«æ›´æ”¹çš„æ•°æ®ã€‚å¯¹ Immutable å¯¹è±¡çš„ä»»ä½•ä¿®æ”¹æˆ–æ·»åŠ åˆ é™¤æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Immutable å¯¹è±¡è€Œä¸ä¼šå¯¹æ—§å¯¹è±¡äº§ç”Ÿä»»ä½•å½±å“ã€‚

ç›®å‰æµè¡Œçš„ Immutable åº“æœ‰ä¸¤ä¸ªï¼š
####  1ã€immutable.js
Immutable.jsæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªJavaScriptçš„æŒä¹…åŒ–æ•°æ®ç»“æ„çš„åº“ ï¼Œä½†æ˜¯ç”±äºåŒæœŸçš„Reactå¤ªç«ï¼Œå¹¶ä¸”å’ŒReactåœ¨æ€§èƒ½ä¼˜åŒ–æ–¹é¢å¤©è¡£æ— ç¼çš„é…åˆï¼Œå¯¼è‡´å¤§å®¶å¸¸å¸¸æŠŠå®ƒä»¬ä¸¤è€…ç»‘å®šåœ¨ä¸€èµ·ã€‚

Facebook å·¥ç¨‹å¸ˆ Lee Byron èŠ±è´¹ 3 å¹´æ—¶é—´æ‰“é€ ï¼Œä¸ React åŒæœŸå‡ºç°ï¼Œä½†æ²¡æœ‰è¢«é»˜è®¤æ”¾åˆ° React å·¥å…·é›†é‡Œï¼ˆReact æä¾›äº†ç®€åŒ–çš„ Helperï¼‰ã€‚å®ƒä»å¤´å¼€å§‹å®ç°äº†å®Œå…¨çš„ `Persistent Data Structureï¼ˆæŒä¹…åŒ–æ•°æ®ç»“æ„ï¼‰`ï¼Œé€šè¿‡ä½¿ç”¨[Vector Trie æ•°æ®ç»“æ„](https://blog.csdn.net/qq_33583069/article/details/51942534)è¿™æ ·çš„å…ˆè¿›æŠ€æœ¯æ¥å®ç°`Structural Sharingï¼ˆç»“æ„å…±äº«ï¼‰`ã€‚æ‰€æœ‰çš„æ›´æ–°æ“ä½œéƒ½ä¼šè¿”å›æ–°çš„å€¼ï¼Œä½†æ˜¯åœ¨å†…éƒ¨ç»“æ„æ˜¯å…±äº«çš„ï¼Œæ¥å‡å°‘å†…å­˜å ç”¨(å’Œåƒåœ¾å›æ”¶çš„å¤±æ•ˆ)ï¼Œä¸”æ•°æ®ç»“æ„å’Œæ–¹æ³•éå¸¸ä¸°å¯Œï¼ˆå®Œå…¨ä¸åƒJSå‡ºèº«çš„å¥½ä¸å¥½ï¼‰ï¼Œåƒ Collectionã€Listã€Mapã€Setã€Recordã€Seqã€‚æœ‰éå¸¸å…¨é¢çš„mapã€filterã€groupByã€reduceã€findå‡½æ•°å¼æ“ä½œæ–¹æ³•ã€‚åŒæ—¶ API ä¹Ÿå°½é‡ä¸ Object æˆ– Array ç±»ä¼¼ã€‚

å…¶ä¸­æœ‰ 3 ç§æœ€é‡è¦çš„æ•°æ®ç»“æ„è¯´æ˜ä¸€ä¸‹ï¼š
* Mapï¼šé”®å€¼å¯¹é›†åˆï¼Œå¯¹åº”äº Objectï¼ŒES6 ä¹Ÿæœ‰ä¸“é—¨çš„ Map å¯¹è±¡ï¼›
* Listï¼šæœ‰åºå¯é‡å¤çš„åˆ—è¡¨ï¼Œå¯¹åº”äº Array
* Setï¼šæ— åºä¸”ä¸å¯é‡å¤çš„åˆ—è¡¨

#### 2ã€seamless-immutable
ä¸` Immutable.js `å­¦é™¢æ´¾çš„é£æ ¼ä¸åŒï¼Œ`seamless-immutable` å¹¶æ²¡æœ‰å®ç°å®Œæ•´çš„` Persistent Data Structureï¼ˆæŒä¹…åŒ–æ•°æ®ç»“æ„ï¼‰`ï¼Œè€Œæ˜¯ä½¿ç”¨ Object.definePropertyï¼ˆå› æ­¤åªèƒ½åœ¨ IE9 åŠä»¥ä¸Šä½¿ç”¨ï¼‰æ‰©å±•äº† JavaScript çš„ Array å’Œ Object å¯¹è±¡æ¥å®ç°ï¼Œåªæ”¯æŒ Array å’Œ Object ä¸¤ç§æ•°æ®ç±»å‹ï¼ŒAPI åŸºæœ¬ä¸ Array å’Œ Object æ“æŒä¸å˜ã€‚ä»£ç åº“éå¸¸å°ï¼Œå‹ç¼©åä¸‹è½½åªæœ‰ 2Kã€‚è€Œ Immutable.js å‹ç¼©åä¸‹è½½æœ‰ 16K;

seamless-immutableçš„å®ç°ä¾èµ–äºECMAScript 5 çš„ä¸€äº›ç‰¹æ€§ï¼Œå¦‚Object.defineProperty å’Œ Object.freezeï¼Œå› æ­¤ä¼šåœ¨æµè§ˆå™¨å…¼å®¹æ€§æ–¹é¢æœ‰æ‰€æ¬ ç¼ºï¼š

![seamlessImmutable](assets/seamlessImmutable-7028643.png)

ä¸è¿‡è¿™ä¸æ˜¯é—®é¢˜å•¦ï¼Œå¯ä»¥ä½¿ç”¨ `polyfill es-shims/es5-shim `æ¥è§£å†³ã€‚

ä¸‹é¢ä¸Šä»£ç æ¥æ„Ÿå—ä¸€ä¸‹ä¸¤è€…çš„ä¸åŒï¼š
```javascript
// åŸæ¥çš„å†™æ³•
const obj1={a: {b: 1}};
const obj2=obj1;
obj2.a.b=2;
console.log(obj1.a.b); //è¾“å‡ºçš„æ˜¯2
console.log(obj1===obj2); //è¾“å‡ºçš„æ˜¯trueï¼ˆobj1å’Œobj2æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºtrueï¼‰

// ä½¿ç”¨ immutable.js å
import Immutable from "immutable";
const obj1=Immutable.fromJS({a:{b:1}});
const obj2=obj1.setIn(["a","b"],2); // ä½¿ç”¨ setIn èµ‹å€¼
console.log(obj1.getIn(["a","b"])); //ä½¿ç”¨ getIn å–å€¼ï¼Œè¾“å‡ºçš„æ˜¯1
console.log(Immutable.is(obj1,obj2)); //è¾“å‡ºfalseï¼ˆé€šè¿‡hashCodeæ¯”è¾ƒé”®å€¼ï¼‰
console.log(obj1===obj2);  //è¾“å‡ºfalseï¼ˆobj1å’Œobj2æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰

// ä½¿ç”¨  seamless-immutable.js å
import Immutable from "seamless-immutable";
const obj1=Immutable({a:{b:1}});
const obj2=obj1.merge({a:{b:2}}); // ä½¿ç”¨ merge èµ‹å€¼
console.log(obj1.a.b);  //åƒåŸç”ŸObjectä¸€æ ·å–å€¼ï¼Œè¾“å‡ºçš„æ˜¯1
console.log(obj1===obj2);  //è¾“å‡ºfalseï¼ˆobj1å’Œobj2æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
```

## Â§ <a name="Immutable-introduce">3.Immutable.jsä»‹ç»</a>

#### Â§ <a name="main-feature">3.1 Immutable.js ä¸»è¦çš„ä¸‰å¤§ç‰¹æ€§</a>
* 1ã€Persistent data structure ï¼ˆæŒä¹…åŒ–æ•°æ®ç»“æ„ï¼‰
* 2ã€structural sharing ï¼ˆç»“æ„å…±äº«ï¼‰
* 3ã€support lazy operation ï¼ˆæƒ°æ€§æ“ä½œï¼‰

ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“ä»‹ç»ä¸‹è¿™ä¸‰ä¸ªç‰¹æ€§ï¼š

##### 1. Persistent data structure ï¼ˆæŒä¹…åŒ–æ•°æ®ç»“æ„ï¼‰

ä¸€èˆ¬å¬åˆ°æŒä¹…åŒ–ï¼Œåœ¨ç¼–ç¨‹ä¸­ç¬¬ä¸€ååº”åº”è¯¥æ˜¯ï¼Œæ•°æ®å­˜åœ¨æŸä¸ªåœ°æ–¹ï¼Œéœ€è¦ç”¨åˆ°çš„æ—¶å€™å°±èƒ½ä»è¿™ä¸ªåœ°æ–¹æ‹¿å‡ºæ¥ç›´æ¥ä½¿ç”¨ã€‚

ä½†è¿™é‡Œè¯´çš„æŒä¹…åŒ–æ˜¯å¦ä¸€ä¸ªæ„æ€ï¼Œç”¨æ¥æè¿°ä¸€ç§æ•°æ®ç»“æ„ï¼Œä¸€èˆ¬å‡½æ•°å¼ç¼–ç¨‹ä¸­éå¸¸å¸¸è§ï¼ŒæŒ‡ä¸€ä¸ªæ•°æ®ï¼Œåœ¨è¢«ä¿®æ”¹æ—¶ï¼Œä»ç„¶èƒ½å¤Ÿä¿æŒä¿®æ”¹å‰çš„çŠ¶æ€ï¼Œä»æœ¬è´¨æ¥è¯´ï¼Œè¿™ç§æ•°æ®ç±»å‹å°±æ˜¯ä¸å¯å˜ç±»å‹ï¼Œä¹Ÿå°±æ˜¯`immutable`â€ƒâ€ƒ

immutable.jsæä¾›äº†åä½™ç§ä¸å¯å˜çš„ç±»å‹ï¼ˆListï¼ŒMapï¼ŒSetï¼ŒSeqï¼ŒCollectionï¼ŒRangeç­‰ï¼‰â€ƒâ€ƒ

åˆ°è¿™ï¼Œæœ‰äº›å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œè¿™å’Œæ·±æ‹·è´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¹Ÿæ˜¯æ¯æ¬¡éƒ½åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå¼€é”€ä¸€æ ·å¾ˆå¤§ã€‚OKï¼Œé‚£æ¥ä¸‹æ¥ç¬¬äºŒä¸ªç‰¹æ€§ä¼šä¸ºä½ æ­å¼€ç–‘æƒ‘ã€‚

##### 2. structural sharing ï¼ˆç»“æ„å…±äº«ï¼‰

structural sharing ï¼ˆç»“æ„å…±äº«ï¼‰å³å¦‚æœå¯¹è±¡æ ‘ä¸­ä¸€ä¸ªèŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼Œåªä¿®æ”¹è¿™ä¸ªèŠ‚ç‚¹å’Œå—å®ƒå½±å“çš„çˆ¶èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹åˆ™è¿›è¡Œå…±äº«ï¼›
è¯·çœ‹ä¸‹é¢åŠ¨ç”»ï¼š

![structuralSharing](assets/structuralSharing.gif)

##### è¡¥å……ï¼š
```javascript
const data={to:7,tea:3,ted:4,ten:12,A:15,i:11,in:5,inn:9}
```
æ ¹æ®trieç»“æ„,å­˜å‚¨çš„ç»“æ„ç±»ä¼¼äº

![trieAddOne1](assets/trieAddOne1.png)

å¦‚æœæ›´æ”¹äº†äº†teaå­—æ®µ 3 ä¸º 14,é‚£ä¹ˆåªéœ€æ”¹å˜å››ä¸ªèŠ‚ç‚¹,æ¥æ›´æ–°å½¢æˆæ–°çš„æ ‘, è¿™å°±æ˜¯ç»“æ„å…±äº«ã€‚

![trieAddOne2](assets/trieAddOne2.jpg)

å…¶å®ï¼Œåœ¨`Immutable.js`ä¸­çš„"èŠ‚ç‚¹"å¹¶ä¸èƒ½ç®€å•çš„ç†è§£æˆå¯¹è±¡ä¸­çš„"key"ï¼Œå…¶å†…éƒ¨ä½¿ç”¨äº†`Vector Trie(Trieå­—å…¸æ ‘çš„ä¸€ç§)`æ•°æ®ç»“æ„ï¼Œ`Immutable.js`ä¼šæŠŠImmutableå¯¹è±¡æ‰€æœ‰çš„keyè¿›è¡Œhashæ˜ å°„ï¼Œå°†å¾—åˆ°çš„hashå€¼è½¬åŒ–ä¸ºäºŒè¿›åˆ¶ï¼Œä»åå‘å‰æ¯5ä½è¿›è¡Œåˆ†å‰²åå†è½¬åŒ–ä¸º`Trieæ ‘`ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸ªä¾‹å­ï¼Œå‡å¦‚æœ‰ä¸ªImmutableå¯¹è±¡zooï¼š

```javascript
const zoo = Immutable.fromJS({
   'frog':ğŸ¸
    'panda':ğŸ¼,
    'monkey':ğŸ’,
    'rabbit':ğŸ°,
    'tiger':ğŸ¯,
    'dog':{
        'dog1':ğŸ¶,
        'dog2':ğŸ•,
        ...// è¿˜æœ‰ 100 ä¸‡åª dog
    }
    ...// å‰©ä½™è¿˜æœ‰ 100 ä¸‡ä¸ªçš„å­—æ®µ
})
```

'frog'è¿›è¡Œ hash ä¹‹åçš„å€¼ä¸º 3151780ï¼Œè½¬æˆäºŒè¿›åˆ¶ `11 00000 00101 11101 00100`ï¼ŒåŒç†'dog' hash åè½¬äºŒæœºåˆ¶ä¸º `11 00001 01001 11100` é‚£ä¹ˆ frog å’Œ dog åœ¨ Immutable å¯¹è±¡çš„ Trie æ ‘çš„ä½ç½®åˆ†åˆ«æ˜¯ï¼š

![trieZoo](assets/trieZoo.jpg)

å½“ç„¶å®é™…çš„`Vector Trie`æ ‘ä¼šæ ¹æ®å®é™…å¯¹è±¡è¿›è¡Œå‰ªæå¤„ç†ï¼Œæ²¡æœ‰å€¼çš„åˆ†æ”¯ä¼šè¢«å‰ªæ‰ï¼Œä¸ä¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½é•¿æ»¡äº†32ä¸ªå­èŠ‚ç‚¹ã€‚

å½“æ¯”å¦‚éœ€è¦å°† zoo.frog ç”± ğŸ¸ æ”¹æˆ ğŸ‘½ ï¼Œå‘ç”Ÿå˜åŠ¨çš„èŠ‚ç‚¹åªæœ‰ä¸Šå›¾ä¸­ç»¿è‰²çš„å‡ ä¸ªï¼Œå…¶ä»–çš„èŠ‚ç‚¹ç›´æ¥å¤ç”¨ï¼Œè¿™æ ·æ¯”æ·±æ‹·è´äº§ç”Ÿçš„100ä¸‡ä¸ªèŠ‚ç‚¹æ•ˆç‡é«˜äº†å¾ˆå¤šã€‚

![trieZooChange](assets/trieZooChange.jpg)

ä¸‹å›¾ä¸­key: **t0143c274**ï¼Œé€šè¿‡ hash åå¾—åˆ°çš„å€¼ä¸º 621051904ï¼ˆä¸ md5 ä¸åŒï¼Œæ¯”å¦‚ hash("a") == 0ï¼Œhash("c") == 2ï¼‰ï¼Œè½¬åŒ–ä¸ºäºŒè¿›åˆ¶åï¼Œå€¼æ˜¯ 10010 10000 01001 00000 00000 00000ï¼ŒæŒ‰ç…§ 5bit åˆ‡åˆ†ï¼Œå¯»å€è·¯å¾„å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![todosTrie](assets/todosTrie.png)

è€Œæ­£æ˜¯å› ä¸ºImmutable.jsé€šè¿‡ä½¿ç”¨[Vector Trie æ•°æ®ç»“æ„](https://blog.csdn.net/qq_33583069/article/details/51942534)è¿™æ ·çš„å…ˆè¿›æŠ€æœ¯å®ç°äº†`Structural Sharingï¼ˆç»“æ„å…±äº«ï¼‰`ï¼ˆå¯å‚è€ƒ[æ·±å…¥æ¢ç©¶immutable.jsçš„å®ç°æœºåˆ¶](https://segmentfault.com/a/1190000016404944)åŠ æ·±ç†è§£ï¼‰ï¼Œç»§è€Œå¸¦äº†ä¸¤å¤§å¥½å¤„ï¼š

##### 2.1ï¼šèŠ‚çœå†…å­˜ï¼Œé¿å…CPUå’Œå†…å­˜çš„æµªè´¹

>æ­¤å¥½å¤„å›åº”è§£ç­”ä¸Šé¢`åœºæ™¯ä¸€`æ‰€ä¸ºå•¥é‡‡ç”¨immutable.js

immutable.js ä½¿ç”¨äº†`ç»“æ„å…±äº«(Structure Sharing)` ä¼šå°½é‡å¤ç”¨å†…å­˜ï¼ˆåŠªåŠ›é¿å…åˆ›å»ºæ–°çš„å¯¹è±¡ï¼‰ï¼Œç”šè‡³ä»¥å‰ä½¿ç”¨çš„å¯¹è±¡ä¹Ÿå¯ä»¥å†æ¬¡è¢«å¤ç”¨ï¼Œæ²¡æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ä¼šè¢«åƒåœ¾å›æ”¶ã€‚

##### ä¾‹1ï¼š

```javascript
const obj1=Immutable.fromJS({
         a:1,
         b:{
             c:3
         }
     });
const obj2=obj1.set("a",100);
console.log(obj1===obj2);//è¾“å‡ºçš„æ˜¯falseï¼ˆobj1å’Œobj2æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡å¹¶ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
console.log(obj1.get("b")===obj2.get("b"));//è¾“å‡ºçš„æ˜¯trueï¼ˆobj1.get("b")å’Œobj2.get("b")æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œå…±äº«äº†æ²¡æœ‰å˜åŒ–çš„bèŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¸ºtrueï¼‰
```

##### ä¾‹2ï¼š
```javascript
const obj1=Immutable.fromJS({
         a:1,
         b:{
             c:3
         }
     });
const obj2=obj1.set("a",100);
const obj3=obj1.set("a",1);
console.log(obj1===obj2);//è¾“å‡ºçš„æ˜¯falseï¼ˆobj1å’Œobj2æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡å¹¶ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
console.log(obj1===obj3);//è¾“å‡ºçš„æ˜¯trueï¼ˆè™½ç„¶obj3è¿›è¡Œäº†ä¸€é¡¿æ“ä½œï¼Œç„¶è€Œæ•°æ®å¹¶æ²¡æœ‰æ”¹å˜,é¿å…åˆ›å»ºäº†æ–°å¯¹è±¡ï¼Œå¤ç”¨äº†å†…å­˜ï¼Œæ‰€ä»¥obj1å’Œobj3æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡è¿˜æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºtrueï¼‰
```

##### 2.1ï¼šæ€§èƒ½çš„æå‡
>æ­¤å¥½å¤„å›åº”è§£ç­”ä¸Šé¢`åœºæ™¯äºŒ`å¯¹åº”çš„ä¸ºå•¥ç”¨immutable.js

ä¸¤ä¸ªImmutable å¯¹è±¡å¯ä»¥ä½¿ç”¨"===" æ¥æ¯”è¾ƒï¼Œè¿™æ ·æ˜¯ç›´æ¥æ¯”è¾ƒä¸¤ä¸ªImmutable å¯¹è±¡æ˜¯å¦æŒ‡å‘äºå †é‡Œçš„åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ€§èƒ½æœ€å¥½ã€‚ä½†å³ä½¿ä¸¤ä¸ªå¯¹è±¡çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿä¼šè¿”å› falseï¼š
```javascript
const obj1=Immutable.Map({a:1,b:1,c:1});
const obj2=Immutable.Map({a:1,b:1,c:1});
console.log(obj1===obj2); //è¾“å‡ºçš„æ˜¯falseï¼ˆobj1å’Œobj2æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡å¹¶ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
```
ä¸ºäº†ç›´æ¥æ¯”è¾ƒå¯¹è±¡çš„å€¼ï¼Œimmutable.js æä¾›äº† Immutable.is() æ¥åšã€å€¼æ¯”è¾ƒã€ã€‚

Immutable.is() æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„ hashCode æˆ– valueOfï¼ˆå¯¹äº JavaScript å¯¹è±¡ï¼‰ã€‚ç”±äº immutable.js å†…éƒ¨ä½¿ç”¨äº† Trie æ•°æ®ç»“æ„æ¥å­˜å‚¨ï¼Œåªè¦ä¸¤ä¸ªå¯¹è±¡çš„ hashCode ç›¸ç­‰ï¼Œå€¼å°±æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·çš„ç®—æ³•é¿å…äº†æ·±åº¦éå†æ¯”è¾ƒï¼Œæ€§èƒ½éå¸¸å¥½ï¼ˆä½ å¯ä»¥ä½¿ç”¨Immutable.hash()æ–¹æ³•å»æŸ¥çœ‹ä¸€çœ‹Immutableå¯¹è±¡çš„hashCodeå€¼ï¼‰ã€‚


ç»“åˆä¸Šé¢2ç‚¹å¥½å¤„ï¼Œæ¥çœ‹ä¸‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œä»¥æ›´å¥½çš„ç†è§£structural sharing ï¼ˆç»“æ„å…±äº«ï¼‰
```javascript
const obj1=Immutable.fromJS({
           a:1,
           b:{
               c:3
           }
       });
const obj2=obj1.set("a",100);
const obj3=Immutable.fromJS({
    a:1,
    b:{
        c:3
    }
});
console.log(obj1===obj2); //è¾“å‡ºçš„æ˜¯falseï¼ˆobj1å’Œobj2æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡å¹¶ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
console.log(obj1===obj3); //è¾“å‡ºçš„æ˜¯falseï¼ˆobj1å’Œobj3æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡å¹¶ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰
console.log(obj1.get("b")===obj2.get("b")); //è¾“å‡ºçš„æ˜¯trueï¼ˆobj1.get("b")å’Œobj2.get("b")æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œå…±äº«äº†æ²¡æœ‰å˜åŒ–çš„bèŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¸ºtrueï¼‰
console.log(obj1.get("b")===obj3.get("b")); //è¾“å‡ºçš„æ˜¯falseï¼ˆobj1.get("b")å’Œobj3.get("b")æŒ‡å‘äºå †é‡Œçš„å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ä¸ºfalseï¼‰;
//è€Œå¦‚æœæˆ‘åªæƒ³æ¯”è¾ƒä¸¤ä¸ªImmutableå¯¹è±¡çš„é”®å€¼æ˜¯å¦ä¸€æ ·ï¼Œå¯ä»¥ç”¨Immutable.is()æ–¹æ³•
console.log(Immutable.is(obj1,obj3)); //è¾“å‡ºçš„æ˜¯true(é€šè¿‡æ¯”è¾ƒobj1å’Œobj3çš„hashCodeå€¼ä¸€æ ·è¿›è€Œæ¯”è¾ƒå‡ºæ¥å€¼ä¹Ÿä¸€æ ·)
```

##### 3.support lazy operation ï¼ˆæƒ°æ€§æ“ä½œï¼‰
* æƒ°æ€§æ“ä½œ Seq
* ç‰¹å¾1ï¼šImmutable (ä¸å¯å˜)
* ç‰¹å¾2ï¼šlazyï¼ˆæƒ°æ€§ï¼Œå»¶è¿Ÿï¼‰

è¿™ä¸ªç‰¹æ€§éå¸¸çš„æœ‰è¶£ï¼Œè¿™é‡Œçš„lazyæŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿå¾ˆéš¾ç”¨è¯­è¨€æ¥æè¿°ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªdemoï¼Œçœ‹å®Œä½ å°±æ˜ç™½äº†

![supportLazyOperation](assets/supportLazyOperation.png)

 è¿™æ®µä»£ç çš„æ„æ€å°±æ˜¯ï¼Œæ•°ç»„å…ˆå–å¥‡æ•°ï¼Œç„¶åå†å¯¹åŸºæ•°è¿›è¡Œå¹³æ–¹æ“ä½œï¼Œç„¶ååœ¨console.logç¬¬2ä¸ªæ•°ï¼ŒåŒæ ·çš„ä»£ç ï¼Œç”¨immutableçš„seqå¯¹è±¡æ¥å®ç°ï¼Œfilteråªæ‰§è¡Œäº†3æ¬¡ï¼Œä½†åŸç”Ÿæ‰§è¡Œäº†8æ¬¡ã€‚
 â€ƒâ€ƒ
å…¶å®åŸç†å°±æ˜¯ï¼Œç”¨seqåˆ›å»ºçš„å¯¹è±¡ï¼Œå…¶å®ä»£ç å—æ²¡æœ‰è¢«æ‰§è¡Œï¼Œåªæ˜¯è¢«å£°æ˜äº†ï¼Œä»£ç åœ¨get(1)çš„æ—¶å€™æ‰ä¼šå®é™…è¢«æ‰§è¡Œï¼Œå–åˆ°index=1çš„æ•°ä¹‹åï¼Œåé¢çš„å°±ä¸ä¼šå†æ‰§è¡Œäº†ï¼Œæ‰€ä»¥åœ¨filteræ—¶ï¼Œç¬¬ä¸‰æ¬¡å°±å–åˆ°äº†è¦çš„æ•°ï¼Œä»4-8éƒ½ä¸ä¼šå†æ‰§è¡Œã€‚
â€ƒâ€ƒ
æƒ³æƒ³ï¼Œå¦‚æœåœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œæ•°æ®é‡éå¸¸å¤§ï¼Œå¦‚åœ¨æˆ‘ä»¬ç‚¹é¤ä¸šåŠ¡ä¸­ï¼Œå•†æˆ·çš„èœå•åˆ—è¡¨å¯èƒ½æœ‰å‡ ç™¾é“èœï¼Œä¸€ä¸ªarrayçš„é•¿åº¦æ˜¯å‡ ç™¾ï¼Œè¦æ“ä½œè¿™æ ·ä¸€ä¸ªarrayï¼Œå¦‚æœåº”ç”¨æƒ°æ€§æ“ä½œçš„ç‰¹æ€§ï¼Œä¼šèŠ‚çœéå¸¸å¤šçš„æ€§èƒ½

#### Â§ <a name="main-advantage">3.2 Immutable.js ä¼˜ç‚¹</a>

##### 1. Immutable é™ä½äº† Mutable å¸¦æ¥çš„å¤æ‚åº¦

å‚è€ƒ"åœºæ™¯ä¸€"ä¾‹1

##### 2. èŠ‚çœå†…å­˜ï¼Œæ€§èƒ½æå‡

å‚è€ƒ"Immutable.js ä¸»è¦çš„ä¸‰å¤§ç‰¹æ€§ä¹‹ç»“æ„å…±äº«"

##### 3. Undo/Redoï¼ŒCopy/Pasteï¼Œç”šè‡³æ—¶é—´æ—…è¡Œè¿™äº›åŠŸèƒ½åšèµ·æ¥å°èœä¸€ç¢Ÿ

å› ä¸ºæ¯æ¬¡æ•°æ®éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œåªè¦æŠŠè¿™äº›æ•°æ®æ”¾åˆ°ä¸€ä¸ªæ•°ç»„é‡Œå‚¨å­˜èµ·æ¥ï¼Œæƒ³å›é€€åˆ°å“ªé‡Œå°±æ‹¿å‡ºå¯¹åº”æ•°æ®å³å¯ï¼Œå¾ˆå®¹æ˜“å¼€å‘å‡ºæ’¤é”€é‡åšè¿™ç§åŠŸèƒ½ã€‚

##### 4. å¹¶å‘å®‰å…¨

ä¼ ç»Ÿçš„å¹¶å‘éå¸¸éš¾åšï¼Œå› ä¸ºè¦å¤„ç†å„ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œå› æ­¤ã€èªæ˜äººã€å‘æ˜äº†å„ç§é”æ¥è§£å†³ã€‚ä½†ä½¿ç”¨äº† Immutable ä¹‹åï¼Œæ•°æ®å¤©ç”Ÿæ˜¯ä¸å¯å˜çš„ï¼Œå¹¶å‘é”å°±ä¸éœ€è¦äº†ã€‚

ç„¶è€Œç°åœ¨å¹¶æ²¡ä»€ä¹ˆåµç”¨ï¼Œå› ä¸º JavaScript è¿˜æ˜¯å•çº¿ç¨‹è¿è¡Œçš„å•Šã€‚ä½†æœªæ¥å¯èƒ½ä¼šåŠ å…¥ï¼Œæå‰è§£å†³æœªæ¥çš„é—®é¢˜ä¸ä¹ŸæŒºå¥½å—ï¼Ÿ

##### 5. æ‹¥æŠ±å‡½æ•°å¼ç¼–ç¨‹

Immutable æœ¬èº«å°±æ˜¯å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„æ¦‚å¿µï¼Œçº¯å‡½æ•°å¼ç¼–ç¨‹æ¯”é¢å‘å¯¹è±¡æ›´é€‚ç”¨äºå‰ç«¯å¼€å‘ã€‚å› ä¸ºåªè¦è¾“å…¥ä¸€è‡´ï¼Œè¾“å‡ºå¿…ç„¶ä¸€è‡´ï¼Œè¿™æ ·å¼€å‘çš„ç»„ä»¶æ›´æ˜“äºè°ƒè¯•å’Œç»„è£…ã€‚

åƒ ClojureScriptï¼ŒElm ç­‰å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­çš„æ•°æ®ç±»å‹å¤©ç”Ÿéƒ½æ˜¯ Immutable çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ ClojureScript åŸºäº React çš„æ¡†æ¶ --- Om æ€§èƒ½æ¯” React è¿˜è¦å¥½çš„åŸå› ã€‚

## Â§ <a name="main-disadvantage">3.3 Immutable.js ç¼ºç‚¹</a>
##### 1. éœ€è¦å­¦ä¹ æ–°çš„ API

##### 2. å¢åŠ äº†èµ„æºæ–‡ä»¶å¤§å°

##### 3. åˆå§‹åŒ–æ•°æ®æ—¶é€Šè‰²äºåŸç”Ÿ

##### 4. å®¹æ˜“ä¸åŸç”Ÿå¯¹è±¡æ··æ·†

è¿™ç‚¹æ˜¯æˆ‘ä»¬ä½¿ç”¨ Immutable.js è¿‡ç¨‹ä¸­é‡åˆ°æœ€å¤§çš„é—®é¢˜ã€‚å†™ä»£ç è¦åšæ€ç»´ä¸Šçš„è½¬å˜ã€‚

è™½ç„¶ Immutable.js å°½é‡å°è¯•æŠŠ API è®¾è®¡çš„åŸç”Ÿå¯¹è±¡ç±»ä¼¼ï¼Œæœ‰çš„æ—¶å€™è¿˜æ˜¯å¾ˆéš¾åŒºåˆ«åˆ°åº•æ˜¯ Immutable å¯¹è±¡è¿˜æ˜¯åŸç”Ÿå¯¹è±¡ï¼Œå®¹æ˜“æ··æ·†æ“ä½œã€‚

Immutable ä¸­çš„ Map å’Œ List è™½å¯¹åº”åŸç”Ÿ Object å’Œ Arrayï¼Œä½†æ“ä½œéå¸¸ä¸åŒï¼Œæ¯”å¦‚ä½ è¦ç”¨ map.get('key') è€Œä¸æ˜¯ map.keyï¼Œarray.get(0) è€Œä¸æ˜¯ array[0]ã€‚å¦å¤– Immutable æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šè¿”å›æ–°å¯¹è±¡ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¿˜è®°èµ‹å€¼ã€‚

å½“ä½¿ç”¨å¤–éƒ¨åº“çš„æ—¶å€™ï¼Œä¸€èˆ¬éœ€è¦ä½¿ç”¨åŸç”Ÿå¯¹è±¡ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¿˜è®°è½¬æ¢ã€‚

ä¸‹é¢ç»™å‡ºä¸€äº›åŠæ³•æ¥é¿å…ç±»ä¼¼é—®é¢˜å‘ç”Ÿï¼š
* 1.ä½¿ç”¨ Flow æˆ– TypeScript è¿™ç±»æœ‰é™æ€ç±»å‹æ£€æŸ¥çš„å·¥å…·;
* 2.çº¦å®šå˜é‡å‘½åè§„åˆ™ï¼šå¦‚æ‰€æœ‰ Immutable ç±»å‹å¯¹è±¡ä»¥ $$ å¼€å¤´;
* 3.ä½¿ç”¨ Immutable.fromJS è€Œä¸æ˜¯ Immutable.Map æˆ– Immutable.List æ¥åˆ›å»ºå¯¹è±¡ï¼Œè¿™æ ·å¯ä»¥é¿å… Immutable å’ŒåŸç”Ÿå¯¹è±¡é—´çš„æ··ç”¨ã€‚
```javascript
//ä½¿ç”¨ Immutable.fromJS
const obj=Immutable.fromJS({
	a:1,
	b:2,
	c:{
	    d:3
	}
});
const getVal=obj.get("c");
console.log(getVal) //getValæ˜¯Immutableå¯¹è±¡

//ä½¿ç”¨ Immutable.Map
const obj2=Immutable.Map({
    a:1,
    b:2,
    c:{
        d:3
    }
});
let getVal=obj2.get("c");
console.log(getVal) //getValæ˜¯JSåŸç”Ÿå¯¹è±¡{d:3}
```

ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜æ˜¯ï¼Œå¯¹ç°æœ‰ä»£ç çš„æ”¹é€ ï¼Œä½¿ç”¨ Immutable.js æˆæœ¬å®åœ¨å¤ªå¤§ã€‚

è€Œseamless-immutableè™½ç„¶æ•°æ®ç»“æ„å’ŒAPIä¸å¦‚Immutable.jsä¸°å¯Œï¼Œä½†æ˜¯å¯¹äºåªæƒ³ä½¿ç”¨Immutable Dataæ¥å¯¹Reactè¿›è¡Œä¼˜åŒ–ä»¥é¿å…é‡å¤æ¸²æŸ“çš„æˆ‘ä»¬æ¥è¯´ï¼Œå·²ç»æ˜¯ç»°ç»°æœ‰ä½™äº†ã€‚è€Œä¸”Arrayå’ŒObjectåŸç”Ÿçš„æ–¹æ³•ç­‰éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼ŒåŸæœ‰é¡¹ç›®æ”¹åŠ¨æå°ã€‚

##  Â§ <a name="immutable-notice">3.4 Immutable.jsä½¿ç”¨è¿‡ç¨‹ä¸­çš„ä¸€äº›æ³¨æ„ç‚¹</a>

* 1.fromJSå’ŒtoJSä¼šæ·±åº¦è½¬æ¢æ•°æ®ï¼Œéšä¹‹å¸¦æ¥çš„å¼€é”€è¾ƒå¤§ï¼Œå°½å¯èƒ½é¿å…ä½¿ç”¨ï¼Œå•å±‚æ•°æ®è½¬æ¢ä½¿ç”¨Map()å’ŒList()ï¼›

ï¼ˆåšäº†ä¸ªç®€å•çš„fromJSå’ŒMapæ€§èƒ½å¯¹æ¯”ï¼ŒåŒç­‰æ¡ä»¶ä¸‹ï¼Œåˆ†åˆ«ç”¨ä¸¤ç§æ–¹æ³•å¤„ç†1000000æ¡æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°fromJSå¼€é”€æ˜¯Mapçš„4å€ï¼‰

![avoidFromJs](assets/avoidFromJs.png)

* 2.jsæ˜¯å¼±ç±»å‹ï¼Œä½†Mapç±»å‹çš„keyå¿…é¡»æ˜¯stringï¼(çœ‹ä¸‹å›¾å®˜ç½‘è¯´æ˜)ï¼›

![mapKeyString](assets/mapKeyString.png)

* 3.æ‰€æœ‰é’ˆå¯¹immutableå˜é‡çš„å¢åˆ æ”¹å¿…é¡»å·¦è¾¹æœ‰èµ‹å€¼ï¼Œå› ä¸ºæ‰€æœ‰æ“ä½œéƒ½ä¸ä¼šæ”¹å˜åŸæ¥çš„å€¼ï¼Œåªæ˜¯ç”Ÿæˆä¸€ä¸ªæ–°çš„å˜é‡ï¼›

```javascript
//javascript
var arr = [1,2,3,4];
arr.push(5);
console.log(arr) //[1,2,3,4,5]

//immutable
var arr = immutable.List([1,2,3,4])
//é”™è¯¯ç”¨æ³•
arr.push(5);
console.log(arr.toJS()) //[1,2,3,4]
//æ­£ç¡®ç”¨æ³•
arr = arr.push(5);
console.log(arr.toJS()) //[1,2,3,4,5]
```

* 4.å¼•å…¥immutablejsåï¼Œä¸åº”è¯¥å†å‡ºç°å¯¹è±¡æ•°ç»„æ‹·è´çš„ä»£ç (å¦‚ä¸‹ä¸¾ä¾‹)ï¼›
```javascript
//es6å¯¹è±¡å¤åˆ¶
const state = Object.assign({}, state, {
    key: value
});

//arrayå¤åˆ¶
const newArr = [].concat([1,2,3])
```

* 5.è·å–æ·±å±‚æ·±å¥—å¯¹è±¡çš„å€¼æ—¶ä¸éœ€è¦åšæ¯ä¸€å±‚çº§çš„åˆ¤ç©ºï¼›
```javascript
//javascript
const obj = {a:1}
const res = obj.a.b.c   //error

//immutable
const immutableData=immutable.fromJS({a:1})
const res = immutableData.getIn(['a', 'b', 'c'])  //undefined
```

* 6.immutableå¯¹è±¡ç›´æ¥å¯ä»¥è½¬JSON.stringify(),ä¸éœ€è¦æ˜¾å¼æ‰‹åŠ¨è°ƒç”¨toJS()è½¬åŸç”Ÿï¼›
* 7.åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯ç©ºå¯ä»¥ç›´æ¥ç”¨sizeï¼›
* 8.è°ƒè¯•è¿‡ç¨‹ä¸­è¦çœ‹ä¸€ä¸ªimmutableå˜é‡ä¸­çœŸå®çš„å€¼ï¼Œå¯ä»¥chromeä¸­åŠ æ–­ç‚¹ï¼Œåœ¨consoleä¸­ä½¿ç”¨.toJS()æ–¹æ³•æ¥æŸ¥çœ‹ï¼›


## Â§ <a name="react-render">4.React é»˜è®¤çš„æ¸²æŸ“è¡Œä¸º</a>
> Reactåœ¨å‡å°‘é‡å¤æ¸²æŸ“æ–¹é¢ç¡®å®æ˜¯æœ‰ä¸€å¥—ç‹¬ç‰¹çš„å¤„ç†åŠæ³•ï¼Œé‚£å°±æ˜¯è™šæ‹ŸDOMï¼Œä½†æ˜¾ç„¶åœ¨é¦–æ¬¡æ¸²æŸ“çš„æ—¶å€™Reactç»æ— å¯èƒ½è¶…è¶ŠåŸç”Ÿçš„é€Ÿåº¦ï¼Œæˆ–è€…ä¸€å®šèƒ½å°†å…¶å®ƒçš„æ¡†æ¶æ¯”ä¸‹å»ã€‚å°¤å…¶æ˜¯åœ¨ä¼˜åŒ–å‰çš„Reactï¼Œæ¯æ¬¡æ•°æ®å˜åŠ¨éƒ½ä¼šæ‰§è¡Œre-renderï¼Œå¤§å¤§å½±å“äº†æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨ç§»åŠ¨ç«¯ã€‚

Reactçš„ç»„ä»¶æ¸²æŸ“åˆ†ä¸ºåˆå§‹åŒ–æ¸²æŸ“ï¼ˆrenderï¼‰å’Œæ›´æ–°æ¸²æŸ“ï¼ˆre-renderï¼‰ã€‚

##### åˆå§‹åŒ–æ¸²æŸ“
åœ¨åˆå§‹åŒ–æ¸²æŸ“çš„æ—¶å€™ä¼šè°ƒç”¨æ ¹ç»„ä»¶ä¸‹çš„æ‰€æœ‰ç»„ä»¶çš„renderæ–¹æ³•è¿›è¡Œæ¸²æŸ“ï¼Œå¦‚ä¸‹å›¾ï¼ˆç»¿è‰²è¡¨ç¤ºå·²æ¸²æŸ“ï¼Œè¿™ä¸€å±‚æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼‰ï¼š

![render](assets/render.jpeg)

##### æå‡ºæ”¹å˜

ä½†æ˜¯å½“æˆ‘ä»¬è¦æ›´æ–°æŸä¸ªå­ç»„ä»¶çš„æ—¶å€™ï¼Œå¦‚ä¸‹å›¾çš„ç»¿è‰²ç»„ä»¶ï¼ˆä»æ ¹ç»„ä»¶ä¼ é€’ä¸‹æ¥åº”ç”¨åœ¨ç»¿è‰²ç»„ä»¶ä¸Šçš„æ•°æ®å‘ç”Ÿæ”¹å˜ï¼‰ï¼š

![changeRender](assets/changeRender.jpeg)

##### ç†æƒ³æ›´æ–°
æˆ‘ä»¬çš„ç†æƒ³çŠ¶æ€æ˜¯åªè°ƒç”¨å…³é”®è·¯å¾„ä¸Šç»„ä»¶çš„renderï¼Œå¦‚ä¸‹å›¾ï¼š

![adjectiveRender](assets/adjectiveRender.jpeg)

##### é»˜è®¤è¡Œä¸º

ä½†æ˜¯Reactçš„é»˜è®¤åšæ³•æ˜¯è°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„renderï¼Œå†å¯¹ç”Ÿæˆçš„è™šæ‹ŸDOMè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚ä¸å˜åˆ™ä¸è¿›è¡Œæ›´æ–°ã€‚è¿™æ ·çš„renderå’Œè™šæ‹ŸDOMçš„å¯¹æ¯”æ˜æ˜¾æ˜¯åœ¨æµªè´¹ï¼Œå¦‚ä¸‹å›¾ï¼ˆé»„è‰²è¡¨ç¤ºæµªè´¹çš„renderå’Œè™šæ‹ŸDOMå¯¹æ¯”ï¼‰

![defaultRender](assets/defaultRender.jpeg)

ä»ä¸Šå›¾å¯ä»¥çœ‹è§ï¼Œç»„ä»¶é™¤äº†å¿…è¦æ¸²æŸ“çš„ä¸‰ä¸ªèŠ‚ç‚¹å¤–ï¼Œè¿˜æ¸²æŸ“äº†å…¶ä»–ä¸å¿…è¦æ¸²æŸ“çš„èŠ‚ç‚¹ï¼Œè¿™å¯¹æ€§èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æµªè´¹ã€‚å¦‚æœå¯¹äºå¤æ‚çš„é¡µé¢ï¼Œè¿™å°†å¯¼è‡´é¡µé¢çš„æ•´ä½“ä½“éªŒæ•ˆæœéå¸¸å·®ã€‚

>**&sect;Tipsï¼š**
  * æ‹†åˆ†ç»„ä»¶æ˜¯æœ‰åˆ©äºå¤ç”¨å’Œç»„ä»¶ä¼˜åŒ–çš„
  * ç”Ÿæˆè™šæ‹ŸDOMå¹¶è¿›è¡Œæ¯”å¯¹å‘ç”Ÿåœ¨render()åï¼Œè€Œä¸æ˜¯render()å‰

#### Â§<a name="life-cycle"> 4.1æ›´æ–°é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸ</a>
* `componentWillReceiveProps(object nextProps)`ï¼šå½“æŒ‚è½½çš„ç»„ä»¶æ¥æ”¶åˆ°æ–°çš„propsæ—¶è¢«è°ƒç”¨ã€‚æ­¤æ–¹æ³•åº”è¯¥è¢«ç”¨äºæ¯”è¾ƒthis.props å’Œ nextPropsä»¥ç”¨äºä½¿ç”¨this.setState()æ‰§è¡ŒçŠ¶æ€è½¬æ¢ã€‚ï¼ˆç»„ä»¶å†…éƒ¨æ•°æ®æœ‰å˜åŒ–ï¼Œä½¿ç”¨stateï¼Œä½†æ˜¯åœ¨æ›´æ–°é˜¶æ®µåˆè¦åœ¨propsæ”¹å˜çš„æ—¶å€™æ”¹å˜stateï¼Œåˆ™åœ¨è¿™ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œé¢ï¼‰ï¼›
* `shouldComponentUpdate(object nextProps, object nextState)`ï¼š è¿”å›å¸ƒå°”å€¼ï¼Œ å½“æœ‰propsæˆ–è€…stateæœ‰æ”¹å˜å‘ç”Ÿæ—¶æ˜¯å¦æ›´æ–°DOMæ—¶è¢«è°ƒç”¨ï¼›
* `componentWillUpdate(object nextProps, object nextState)`ï¼šåœ¨æ›´æ–°å‘ç”Ÿå‰è¢«ç«‹å³è°ƒç”¨ã€‚ä½ ä¸èƒ½åœ¨æ­¤è°ƒç”¨this.setState()ï¼›
* `componentDidUpdate(object prevProps, object prevState)`ï¼š åœ¨æ›´æ–°å‘ç”Ÿåè¢«ç«‹å³è°ƒç”¨ã€‚ï¼ˆå¯ä»¥åœ¨DOMæ›´æ–°å®Œä¹‹åï¼Œåšä¸€äº›æ”¶å°¾çš„å·¥ä½œï¼‰

>**&sect;Tipsï¼š**
>
>  * Reactçš„ä¼˜åŒ–æ˜¯åŸºäº`shouldComponentUpdate`çš„ï¼Œè¯¥ç”Ÿå‘½å‘¨æœŸé»˜è®¤è¿”å›trueï¼Œæ‰€ä»¥ä¸€æ—¦propæˆ–stateæœ‰ä»»ä½•å˜åŒ–ï¼Œéƒ½ä¼šå¼•èµ·é‡æ–°re-render

#### Â§<a name="about-shouldComponentUpdate"> 4.2å…³äºshouldComponentUpdate</a>

**shouldComponentUpdate æ˜¯Reactæ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚**ï¼ˆè”ç³»"åœºæ™¯äºŒ"ï¼Œã€===å€¼æ¯”è¾ƒã€ï¼‰
Reactçš„é‡å¤æ¸²æŸ“ä¼˜åŒ–çš„æ ¸å¿ƒå…¶å®å°±æ˜¯åœ¨shouldComponentUpdateé‡Œé¢åšæ•°æ®æ¯”è¾ƒã€‚åœ¨ä¼˜åŒ–ä¹‹å‰ï¼ŒshouldComponentUpdateæ˜¯é»˜è®¤è¿”å›trueçš„ï¼Œè¿™å¯¼è‡´ä»»ä½•æ—¶å€™è§¦å‘ä»»ä½•çš„æ•°æ®å˜åŒ–éƒ½ä¼šä½¿Reactç»„ä»¶componenté‡æ–°æ¸²æŸ“ã€‚è¿™å¿…ç„¶ä¼šå¯¼è‡´èµ„æºçš„æµªè´¹å’Œæ€§èƒ½çš„ä½ä¸‹â€”â€”ä½ å¯èƒ½ä¼šæ„Ÿè§‰æ¯”è¾ƒåŸç”Ÿçš„å“åº”æ›´æ…¢ã€‚

ä¸ºäº†è¿›ä¸€æ­¥è¯´æ˜é—®é¢˜ï¼Œæˆ‘ä»¬å†å¼•ç”¨ä¸€å¼ å®˜ç½‘çš„å›¾æ¥è§£é‡Šï¼Œå¦‚ä¸‹å›¾ï¼ˆ SCUè¡¨ç¤ºshouldComponentUpdateï¼Œç»¿è‰²è¡¨ç¤ºè¿”å›true(éœ€è¦æ›´æ–°)ï¼Œçº¢è‰²è¡¨ç¤ºè¿”å›false(ä¸éœ€è¦æ›´æ–°)ï¼›vDOMEqè¡¨ç¤ºè™šæ‹ŸDOMæ¯”å¯¹ï¼Œç»¿è‰²è¡¨ç¤ºä¸€è‡´(ä¸éœ€è¦æ›´æ–°)ï¼Œçº¢è‰²è¡¨ç¤ºå‘ç”Ÿæ”¹å˜(éœ€è¦æ›´æ–°)ï¼‰ï¼š

![shouldComponentUpdate](assets/shouldComponentUpdate.png)

æ ¹æ®æ¸²æŸ“æµç¨‹ï¼Œé¦–å…ˆä¼šåˆ¤æ–­shouldComponentUpdate(SCU)æ˜¯å¦éœ€è¦æ›´æ–°ã€‚å¦‚æœéœ€è¦æ›´æ–°ï¼Œåˆ™è°ƒç”¨ç»„ä»¶çš„renderç”Ÿæˆæ–°çš„è™šæ‹ŸDOMï¼Œç„¶åå†ä¸æ—§çš„è™šæ‹ŸDOMå¯¹æ¯”(vDOMEq)ï¼Œå¦‚æœå¯¹æ¯”ä¸€è‡´å°±ä¸æ›´æ–°ï¼Œå¦‚æœå¯¹æ¯”ä¸åŒï¼Œåˆ™æ ¹æ®æœ€å°ç²’åº¦æ”¹å˜å»æ›´æ–°DOMï¼›å¦‚æœSCUä¸éœ€è¦æ›´æ–°ï¼Œåˆ™ç›´æ¥ä¿æŒä¸å˜ï¼ŒåŒæ—¶å…¶å­å…ƒç´ ä¹Ÿä¿æŒä¸å˜ã€‚

* C1æ ¹èŠ‚ç‚¹ï¼Œç»¿è‰²SCU (true)ï¼Œè¡¨ç¤ºéœ€è¦æ›´æ–°ï¼Œç„¶åvDOMEqçº¢è‰²ï¼Œè¡¨ç¤ºè™šæ‹ŸDOMä¸ä¸€è‡´ï¼Œéœ€è¦æ›´æ–°ã€‚
* C2èŠ‚ç‚¹ï¼Œçº¢è‰²SCU (false)ï¼Œè¡¨ç¤ºä¸éœ€è¦æ›´æ–°ï¼Œæ‰€ä»¥C4,C5å‡ä¸å†è¿›è¡Œæ£€æŸ¥
* C3èŠ‚ç‚¹åŒC1ï¼Œéœ€è¦æ›´æ–°
* C6èŠ‚ç‚¹ï¼Œç»¿è‰²SCU (true)ï¼Œè¡¨ç¤ºéœ€è¦æ›´æ–°ï¼Œç„¶åvDOMEqçº¢è‰²ï¼Œè¡¨ç¤ºè™šæ‹ŸDOMä¸ä¸€è‡´ï¼Œæ›´æ–°DOMã€‚
* C7èŠ‚ç‚¹åŒC2
* C8èŠ‚ç‚¹ï¼Œç»¿è‰²SCU (true)ï¼Œè¡¨ç¤ºéœ€è¦æ›´æ–°ï¼Œç„¶åvDOMEqç»¿è‰²ï¼Œè¡¨ç¤ºè™šæ‹ŸDOMä¸€è‡´ï¼Œä¸æ›´æ–°DOMã€‚

>**&sect;Tipsï¼š**
>
>  * Reactæ¸²æŸ“æ›´æ–°DOMä¸å¦æ˜¯å…ˆæ ¹æ®renderçš„é€»è¾‘ç”Ÿæˆè™šæ‹ŸDOMï¼Œå†ä¸æ—§çš„è™šæ‹ŸDOMè¿›è¡Œå¯¹æ¯”ï¼Œæ±‚å‡ºæœ€å°DOMæ›´æ–°æ“ä½œï¼ˆReact diff ä¼šå¸®åŠ©æˆ‘ä»¬è®¡ç®—å‡º Virtual DOM ä¸­çœŸæ­£å˜åŒ–çš„éƒ¨åˆ†ï¼Œå¹¶åªé’ˆå¯¹è¯¥éƒ¨åˆ†è¿›è¡Œå®é™… DOM æ“ä½œï¼‰ï¼Œè¿™æ˜¯Reactåšçš„äº‹æƒ…ã€‚shouldComponentUpdateè§£å†³çš„æ˜¯Reactçš„æ ‘å½¢ç»“æ„å¤§äº†ä¹‹åï¼Œè™šæ‹ŸDOMçš„ç”Ÿæˆéå¸¸å¡çš„é—®é¢˜ï¼Œå› ä¸ºrenderæ–¹æ³•ä¸åŠ é™åˆ¶çš„è¯æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œï¼Œè€ŒshouldComponentUpdateæ­£æ˜¯ä¸ºäº†é¿å…ä¸å¿…è¦çš„renderï¼Œä»è€Œæé«˜è™šæ‹ŸDOMçš„ç”Ÿæˆé€Ÿåº¦ã€‚ è€å®è¯´å¦‚æœä¸ä½¿ç”¨shouldComponentUpdateè¿›è¡Œé™åˆ¶çš„è¯ï¼Œreactçš„æ€§èƒ½æ˜¯éå¸¸å·®çš„ã€‚

#### Â§<a name="focus-point"> 4.3å¸¦å‘çš„ä¸€äº›æ³¨æ„ç‚¹</a>
* {...this.props} (ä¸è¦æ»¥ç”¨ï¼Œè¯·åªä¼ é€’componentéœ€è¦çš„propsï¼Œä¼ å¾—å¤ªå¤šï¼Œæˆ–è€…å±‚æ¬¡ä¼ å¾—å¤ªæ·±ï¼Œéƒ½ä¼šåŠ é‡shouldComponentUpdateé‡Œé¢çš„æ•°æ®æ¯”è¾ƒè´Ÿæ‹…ï¼Œå› æ­¤ï¼Œè¯·æ…ç”¨spread attributesï¼ˆ<Component {...props} />ï¼‰)ã€‚

* å¤æ‚çš„é¡µé¢ä¸è¦åœ¨ä¸€ä¸ªç»„ä»¶é‡Œé¢å†™å®Œã€‚

* è¯·å°½é‡ä½¿ç”¨const elementï¼ˆè¿™ä¸ªç”¨æ³•æ˜¯å·¥ä¸šèšåœ¨Reactè®¨è®ºå¾®ä¿¡ç¾¤é‡Œæ•™ä¼šçš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸æ€ä¹ˆå˜åŠ¨ï¼Œæˆ–è€…ä¸éœ€è¦ä¼ å…¥çŠ¶æ€çš„componentå†™æˆconst elementçš„å½¢å¼ï¼Œè¿™æ ·èƒ½åŠ å¿«è¿™ä¸ªelementçš„åˆå§‹æ¸²æŸ“é€Ÿåº¦ï¼‰

* mapé‡Œé¢æ·»åŠ keyï¼Œå¹¶ä¸”keyä¸è¦ä½¿ç”¨indexï¼ˆå¯å˜çš„ï¼‰ã€‚å…·ä½“å¯å‚è€ƒ[ä½¿ç”¨Perfå·¥å…·ç ”ç©¶React Keyå¯¹æ¸²æŸ“çš„å½±å“](http://levy.work/2016-08-31-debug-react-key-with-performance-tool/)ï¼Œ[Reactä¸­keyçš„å¿…è¦æ€§ä¸ä½¿ç”¨](https://www.jianshu.com/p/0218ff2591ec)

* å°½é‡å°‘ç”¨setTimeOutæˆ–ä¸å¯æ§çš„refsã€DOMæ“ä½œã€‚

* propså’Œstateçš„æ•°æ®å°½å¯èƒ½ç®€å•æ˜äº†ï¼Œæ‰å¹³åŒ–ã€‚

* ä½¿ç”¨return nullè€Œä¸æ˜¯CSSçš„display:noneæ¥æ§åˆ¶èŠ‚ç‚¹çš„æ˜¾ç¤ºéšè—ã€‚ä¿è¯åŒä¸€æ—¶é—´é¡µé¢çš„DOMèŠ‚ç‚¹å°½å¯èƒ½çš„å°‘ã€‚

* è¯·å°†æ–¹æ³•çš„bindä¸€å¾‹ç½®äºconstructoræˆ–è€…ä½¿ç”¨es6çš„ç®­å¤´å‡½æ•°ï¼Œå»ºè®®ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼ˆComponentçš„renderé‡Œä¸åŠ¨æ€bindæ–¹æ³•ï¼Œæ–¹æ³•éƒ½åœ¨constructoré‡Œbindå¥½ï¼Œå¦‚æœè¦åŠ¨æ€ä¼ å‚ï¼Œæ–¹æ³•å¯ä½¿ç”¨é—­åŒ…è¿”å›ä¸€ä¸ªæœ€ç»ˆå¯æ‰§è¡Œå‡½æ•°ã€‚å¦‚ï¼šshowDelBtn(item) { return (e) => {}; }ã€‚å¦‚æœæ¯æ¬¡éƒ½åœ¨renderé‡Œé¢çš„jsxå»bindè¿™ä¸ªæ–¹æ³•ï¼Œæ¯æ¬¡éƒ½è¦ç»‘å®šä¼šæ¶ˆè€—æ€§èƒ½ã€‚ï¼‰

  > è¿™å„¿è¡¥å……ä¸‹Reactä¸­ä¸¤ç§ç»‘å®šthisçš„æ–¹æ³•ï¼Œå‚è€ƒé“¾æ¥ï¼š[React äº‹ä»¶ç»‘å®š this](https://github.com/nanyang24/blog/issues/75)
  >
  > **Constructor bind vs Class properties**
  >
  > Constructor bind å°±æ˜¯åœ¨ Class çš„ constructor ä¸­ä¸ºæ–¹æ³• bind thisï¼Œä¸ä»…æ˜¾å¼çš„å†™äº†å¾ˆå¤šå¼ºç»‘å®šï¼Œå¹¶ä¸” æ–¹æ³•å£°æ˜ ä¸ å¼ºåˆ¶ç»‘å®š åˆ†å‰²åœ¨ä¸åŒçš„åœ°æ–¹:
  >
  > ```javascript
  > class Comp extends React.Component {
  > constructor() {
  >  super();
  >  this.toggleButton = this.toggleButton.bind(this);
  > }
  > 
  > toggleButton() {
  >  this.setState(prevState => ({ toggle: !prevState.toggle }));
  > }
  > 
  > ...
  > }
  > ```
  >
  > OKï¼Œç°åœ¨æœ‰ä¸€ä¸ªå¤„äº Stage é˜¶æ®µçš„è¯­æ³•ææ¡ˆï¼š`Public Class Fields`
  > å…¶ä¸­ä¸€ä¸ªç‰¹æ€§å°±æ˜¯ å¯ä»¥ç±»ä¸­ä½¿ç”¨ç®­å¤´å‡½æ•°è¯­æ³•(åˆ©ç”¨ Babelï¼Œæˆ‘ä»¬å¯ä»¥æå‰ä½¿ç”¨å®ƒ,[babel/plugin-proposal-class-properties Â· Babel](https://babeljs.io/docs/en/babel-plugin-proposal-class-properties)):
  >
  > ```javascript
  > class Comp extends React.Component {
  > 
  > toggleButton = ()=> {
  >  this.setState(prevState => ({ toggle: !prevState.toggle }));
  > }
  > 
  > ...
  > }
  > ```
  >
  > **ä¸€èˆ¬æ¥è®²ï¼Œè¿™ä¸¤ç§æ–¹å¼å”¯ä¸€çš„å·®åˆ«å°±æ˜¯æ€§èƒ½å’Œå†…å­˜**
  >
  > > è¿™æ˜¯ Donavon West  çš„ä¸€ç¯‡æ–‡ç« ï¼Œè¯¦ç»†è§£é‡Šäº† ä¸¤ç§ bind this æ–¹æ³• çš„æ€§èƒ½é—®é¢˜[Demystifying Memory Usage using ES6 React Classes â€“ DailyJS â€“ Medium](https://medium.com/dailyjs/demystifying-memory-usage-using-es6-react-classes-d9d904bc4557)
  >
  > ç®€å•æ¥è¯´ï¼š
  >
  > * å½“åˆ©ç”¨ `Public Class Fields`ï¼Œä½¿ç”¨ ç®­å¤´å‡½æ•° ç¼–å†™ç±»æ–¹æ³•ï¼Œæ–¹æ³•ä¼šå£°æ˜åœ¨æ¯ä¸ªç±»å®ä¾‹ä¸Š
  >
  > ```javascript
  > handler = () => {
  > 	//
  > }
  > ```
  >
  > * è€Œä½¿ç”¨åŸæœ¬çš„ç±»æ–¹æ³•ï¼Œæ–¹æ³•ä¼šå£°æ˜åœ¨ ç±»çš„åŸå‹ä¸Šé¢ï¼Œæ‰€æœ‰å®ä¾‹éƒ½å¯å¤ç”¨
  >
  >   ```javascript
  >   handler() {
  >   	//
  >   }
  >   ```
  >
  > ç¡®ç¡®å®å®æ˜¯å­˜åœ¨ä¸Šé¢çš„å·®å¼‚ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨Reactå½“ä¸­ç»å¸¸éœ€è¦åœ¨å‡½æ•°é‡Œé¢è®¿é—®thisï¼Œç”¨åŸæœ¬çš„ç±»æ–¹æ³•è¦è®¿é—®åˆ°thiséœ€è¦åœ¨constructoré‡Œé¢åˆ©ç”¨ bindç»‘å®šåˆ°å®ä¾‹ä¸Šï¼Œè¿™æ ·çš„è¯æ— å¼‚äºç”¨ç®­å¤´å‡½æ•°ç¼–å†™ç±»æ–¹æ³•(å£°æ˜ç°åœ¨æ¯ä¸ªå®ä¾‹ä¸Š)ï¼Œè€Œä¸”è¿˜åœ¨å…¶åŸå‹ä¸Šå¤šäº†ä¸€ä¸ªå£°æ˜çš„æ–¹æ³•ï¼›
  >
  > ```javascript
  > class A {
  >   constructor(){
  >     this.fn = this.fn.bind(this);
  >   }
  >    fn(){
  >     //...
  >    }
  > }
  > 
  > const a =new A();
  > 
  > console.log(A,a.hasOwnProperty("fn"));
  > ```
  >
  > ![thisBind](assets/thisBind.jpg)
  >



## Â§ <a name="react-solve">5.Reactå®˜æ–¹çš„è§£å†³æ–¹æ¡ˆ</a>

éšç€Reactç‰ˆæœ¬è¿­ä»£ï¼ŒReactå®˜æ–¹æœ‰è¿‡ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š

#### Â§<a name="PureRenderMixin"> 5.1PureRenderMixin</a>
 es5æ—¶æœŸçš„`PureRenderMixin`([react-addons-pure-render-mixin](https://www.npmjs.com/package/react-addons-pure-render-mixin))ï¼Œä½†å› ä¸ºå’±ç”¨çš„æ˜¯es2015 class çš„æ–¹å¼å®šä¹‰çš„ Componentï¼Œå·²ç»ä¸æ”¯æŒmixinäº†ï¼Œè¿™å·²ç»è¢«ä»React 15.3.0 æ–°å¢çš„ `PureComponent `ç±»æ›¿ä»£

![pureRenderMixin](assets/pureRenderMixin.png)

#### Â§<a name="pureRender"> 5.2pureRender</a>
å¸¦æœ‰es7è£…é¥°å™¨@å†™æ³•çš„`pureRender`([pure-render-decorator](https://www.npmjs.com/package/pure-render-decorator))ï¼Œä½†è¿™ä¹Ÿå·²ç»è¢«ä»React 15.3.0 æ–°å¢çš„ `PureComponent `ç±»æ›¿ä»£äº†

![pureRender](assets/pureRender.png)

#### Â§<a name="shallowCompare">5.3shallowCompare</a>

`shallowCompare`([react-addons-shallow-compare](https://reactjs.org/docs/shallow-compare.html))ï¼Œè¿™ä¹Ÿå·²ç»è¢«ä»React 15.3.0 æ–°å¢çš„ `PureComponent `ç±»æ›¿ä»£äº†ã€ã€ã€

![shallowCompare](assets/shallowCompare.png)

#### Â§<a name="PureComponent"> 5.4PureComponent</a>

è¿™ä¸ªæ›¿ä»£ä¼—å¤šæ–¹æ¡ˆçš„PureComponentå®é™…ä¸Šè·Ÿä¹‹å‰é¢çš„æ–¹æ¡ˆæ˜¯ç­‰ä»·çš„ï¼Œåªæ˜¯å†™èµ·æ¥ä¼šæ›´åŠ ç®€ä»‹ä¼˜é›…ï¼Œç›¸æ¯”è€Œè¨€â€œæ ¹çº¢è‹—æ­£â€æ˜¯ç„¶åé—æ†¾çš„æ˜¯`PureComponent`ä¹Ÿæ˜¯shallowCompareï¼ˆæµ…æ¯”è¾ƒï¼‰ã€ã€ã€

##### ä¾‹1ï¼š
```javascript
//çˆ¶ç»„ä»¶
class PageOne extends React.Component{
    constructor(props){
        super(props);
        this.state={
            count:1,
            name:"å°ç™½",
            age:20
        };
        this.increaseTimes=this.increaseTimes.bind(this);
    }
    increaseTimes(){
        this.setState({
            count:this.state.count+1,
            name:"å°ç™½",
            age:21
        })
    }
    render(){
        const {count,name,age}=this.state;
        return(
            <ul className="pageOne">
                <li>
                    <span>æ›´æ”¹æ¬¡æ•°ï¼šæ›´æ”¹+{count}</span>
                    <button onClick={this.increaseTimes}>ç‚¹æˆ‘</button>
                </li>
                <Person name={name} age={age}/>
            </ul>
        )
    }
}

//å­ç»„ä»¶
class Person extends React.PureComponent{
    constructor(props){
        super(props)
    }
    render(){
        console.log("æˆ‘re-renderäº†");
        let {name,age}=this.props;
        return(
            <li>
                åå­—æ˜¯ï¼š{name}ï¼Œ
                å¹´é¾„æ˜¯ï¼š{age}
            </li>
        )
    }
}
```

![pureComponentExample](assets/pureComponentExample.png)

* æˆ‘ç¬¬ä¸€æ¬¡å»è§¦å‘çˆ¶ç»„ä»¶ä¸­æŒ‰é’®buttonçš„onClickç‚¹å‡»äº‹ä»¶ï¼Œç”±äºä¼ è¿‡å»`Person`å­ç»„ä»¶çš„ageä»20æ›´æ”¹åˆ°äº†21ï¼Œå­ç»„ä»¶`Person`é‡æ¸²æŸ“äº†ä¸€æ¬¡ï¼ŒOKçš„ï¼›
* è€Œåæˆ‘å†å»è§¦å‘çˆ¶ç»„ä»¶ä¸­æŒ‰é’®buttonçš„onClickç‚¹å‡»äº‹ä»¶ï¼Œä¼ è¿‡`Person`å­ç»„ä»¶çš„ageå’Œnameéƒ½æ²¡å‘ç”Ÿæ”¹å˜ï¼Œè¿˜æ˜¯ä¸Šä¸€æ¬¡çš„20å’Œ"å°ç™½"ï¼Œç”±äºç”¨äº†`React.PureComponent`ï¼Œè§£å†³äº†å¦‚æœç”¨`React.Component`é€ æˆçš„å­ç»„ä»¶é‡æ¸²æŸ“é—®é¢˜ï¼›

åˆ°æ­¤å¯èƒ½ä¼šè§‰ç€ç”¨`React.PureComponent`èƒ½è§£å†³Reactç»„ä»¶componentçš„é‡æ¸²æŸ“é—®é¢˜è¿›è€Œé¿å…ä¸è¦çš„æ€§èƒ½æµªè´¹ï¼Œç„¶è€Œé—æ†¾çš„æ˜¯**React.PureComponentåªæ˜¯shallowCompareï¼ˆæµ…æ¯”è¾ƒï¼‰ï¼ˆåªæ¯”è¾ƒç¬¬ä¸€å±‚çš„å€¼æ˜¯å¦ç›¸åŒï¼Œè€Œå¯¹äºå¼•ç”¨æ•°æ®ç±»å‹çš„ã€å€¼æ¯”è¾ƒã€æ˜¯æ¯”è¾ƒæ˜¯å¦æŒ‡å‘çš„å †é‡Œçš„åŒä¸€ä¸ªå¯¹è±¡ï¼‰**ï¼Œä¹Ÿå°±æ˜¯è¯´`React.PureComponent`åªä¼šå½“ç»„ä»¶çš„ state æˆ–è€… props æ²¡æœ‰åµŒå¥—ç»“æ„çš„æ—¶å€™æ‰ä¼šæ­£ç¡®æŒ‰ç…§é¢„æœŸå‘æŒ¥ä½œç”¨ï¼Œå¦‚æœæœ‰åµŒå¥—å±‚çš„è¯ï¼ˆåœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼ŒåµŒå¥—çš„ state æˆ–è€… props ç»“æ„æ˜¯å¾ˆå¸¸è§çš„ï¼‰ï¼ŒReact.PureComponentå°±ä¼šå› ä¸ºæµ…æ¯”è¾ƒè€Œå‡ºç°é—®é¢˜

##### ä¾‹2ï¼š
```javascript
//çˆ¶ç»„ä»¶
class PageOne extends React.Component{
    constructor(props){
        super(props);
        this.state={
            count:1,
            person:{
                name:"å°ç™½",
                age:20
            }
        };
        this.increaseTimes=this.increaseTimes.bind(this);
    }
    increaseTimes(){
        this.setState(prevState => ({
            count:prevState.count+1,
            person:{
                name:"å°ç™½",
                age:20
            }
        }))
    }
    render(){
        const {count,person}=this.state;
        return(
            <ul className="pageOne">
                <li>
                    <span>æ›´æ”¹æ¬¡æ•°ï¼šæ›´æ”¹+{count}</span>
                    <button onClick={this.increaseTimes}>ç‚¹æˆ‘</button>
                </li>
                <Person person={person}/>
            </ul>
        )
    }
}

//å­ç»„ä»¶
class Person extends React.PureComponent{
    constructor(props){
        super(props)
    }
    render(){
        console.log("æˆ‘re-renderäº†");
        const {person:{name,age}=this.props;
        return(
            <li>
                åå­—æ˜¯ï¼š{name}ï¼Œ
                å¹´é¾„æ˜¯ï¼š{age}
            </li>
        )
    }
}
```

![pureComponentFlaw](assets/pureComponentFlaw.png)

* æˆ‘è§¦å‘å¤šå°‘æ¬¡çˆ¶ç»„ä»¶çš„æŒ‰é’®onClickç‚¹å‡»äº‹ä»¶ï¼Œå­ç»„ä»¶`Person`å°±ä¼šé‡æ¸²æŸ“å¤šå°‘æ¬¡ï¼Œè™½ç„¶ä¼ è¿‡å»çš„ä¸€ç›´éƒ½æ˜¯{name:"å°ç™½",age:"20"}ï¼›

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º`React.PureComponent`çš„æµ…æ¯”è¾ƒæŠŠ{name:"å°ç™½",age:"20"}å’Œä¸‹ä¸€æ¬¡çš„{name:"å°ç™½",age:"20"}æ¯”è¾ƒå‡ºæ¥æ˜¯ä¸ä¸€æ ·ä¸ä¸€æ ·çš„ï¼ˆå› ä¸ºæŒ‡å‘äºå †å†…å­˜ä¸­çš„å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªï¼‰ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸ºè¦é‡æ–°æ¸²æŸ“ï¼ï¼ï¼

**ç„¶åæˆ‘ä»¬å†æ¥é€šè¿‡ä»£ç çœ‹çœ‹è¿™Reactå®˜æ–¹æä¾›çš„è¿™å‡ ç§è§£å†³æ–¹æ¡ˆ**

è®©æˆ‘ä»¬æ‰’æ‹‰ä¸€ä¸‹Reactçš„æºç ï¼Œ[ä»£ç é“¾æ¥](https://github.com/facebook/react/blob/v15.3.2/src/renderers/shared/stack/reconciler/ReactCompositeComponent.js#L816)

```javascript
if (this._compositeType === CompositeTypes.PureClass) {
  shouldUpdate =
    !shallowEqual(prevProps, nextProps) ||
    !shallowEqual(inst.state, nextState);
}
```

è¿™é‡Œçš„ shouldUpdate å˜é‡å°±æ˜¯åœ¨åé¢çš„é€»è¾‘ä¸­ç”¨äºåˆ¤æ–­è¯¥ä¸è¯¥é‡æ–°æ¸²æŸ“ç»„ä»¶çš„ï¼Œè¿™é‡Œæœ‰ä¸ª shallowEqual å‡½æ•°ï¼Œæˆ‘ä»¬æš‚ä¸”ä¸è¡¨ã€‚

æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ PureRenderMixin çš„ä»£ç ï¼Œ[ä»£ç é“¾æ¥](https://github.com/facebook/react/blob/v15.3.2/src/addons/ReactComponentWithPureRenderMixin.js)

```javascript
var ReactComponentWithPureRenderMixin = {
  shouldComponentUpdate: function(nextProps, nextState) {
    return shallowCompare(this, nextProps, nextState);
  },
};
module.exports = ReactComponentWithPureRenderMixin;
```
è¿™ä¸ªMixinå°±æ˜¯å¸®æˆ‘ä»¬å®ç°äº† shouldComponentUpdate å‡½æ•°ï¼ŒåŸæ¥è¿™é‡Œç”¨åˆ°äº† shallowCompare æ–¹æ³•ï¼Œé‚£å¥½ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹çœ‹ shallowCompare æ–¹æ³•çš„ä»£ç ,[ä»£ç é“¾æ¥](https://github.com/facebook/react/blob/v15.3.2/src/addons/shallowCompare.js)

```javascript
function shallowCompare(instance, nextProps, nextState) {
  return (
    !shallowEqual(instance.props, nextProps) ||
    !shallowEqual(instance.state, nextState)
  );
}
```

OKï¼OKï¼ çœ‹åˆ°äº†å§ï¼ŒshallowCompare ä¹Ÿæ˜¯å¯¹ shallowEqual çš„å°è£…ï¼Œæ‰€ä»¥Reactå®˜æ–¹æä¾›çš„è¿™å‡ ç§è§£å†³æ–¹æ¡ˆå½’æ ¹æ­åº•éƒ½æ˜¯ä¸€æ ·çš„ã€‚

é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨åªè¦ææ¸…æ¥š shallowEqual æ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¸Šé¢çš„é—®é¢˜å°±çœŸç›¸å¤§ç™½äº†ï¼Œçœ‹ä»£ç ï¼š[ä»£ç é“¾æ¥](https://github.com/facebook/fbjs/blob/master/packages/fbjs/src/core/shallowEqual.js)

> shallowEqual ä¸æ˜¯ReactJSçš„ä»£ç ï¼Œå®ƒæ˜¯Facebookçš„ä¸€ä¸ªå·¥å…·åº“ï¼šfbjs

è¿™ä¸ªæ–¹æ³•é‡ç‚¹å…³æ³¨ä¸¤ä¸ªç‚¹ï¼š
* 1.å¦‚å®ƒçš„åå­—ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ³•åªè¿›è¡Œå¯¹è±¡çš„æµ…æ¯”è¾ƒï¼Œæˆ‘ä»¬çŸ¥é“deepCompareæ˜¯å¾ªç¯é€’å½’æ“ä½œï¼Œå¼€é”€ä¼šæ¯”è¾ƒå¤§ï¼Œå¾—ä¸å¿å¤±çš„ã€‚
* 2.æ¯”è¾ƒå¯¹è±¡å±æ€§çš„å€¼ï¼Œç”¨çš„æ˜¯ Object.is æ–¹æ³•;
```javascript
const isEqual=Object.is(
    {name:"å°ç™½",age:20},
    {name:"å°ç™½",age:20}
);
console.log(isEqual,"isEqual")//è¾“å‡ºçš„æ˜¯false
```

æ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº†:
* å¦‚ä½•é¿å…Reactç»„ä»¶çš„é‡æ¸²æŸ“è€Œé€ æˆä¸å¿…è¦çš„æµªè´¹å…³é”®ä¹‹å¤„åœ¨äºæ§åˆ¶Reactç”Ÿå‘½å‘¨æœŸä¸­çš„shouldComponentUpdate()

* ç„¶è€ŒReactå®˜æ–¹æä¾›çš„å‡ ç§è§£å†³æ–¹æ¡ˆéƒ½åªæ˜¯æµ…æ¯”è¾ƒ(shallowCompare)ï¼Œå½“ä¼ å…¥propsæˆ–stateä¸æ­¢ä¸€å±‚ï¼Œæµ…æ¯”è¾ƒ(shallowCompare)å°±å¤±æ•ˆäº†ã€‚

  > å‡è®¾çˆ¶ç»„ä»¶`<Parent />`ï¼Œå­ç»„ä»¶`<Child />`
  >
  > å­ç»„ä»¶ä½¿ç”¨`shallowCompare`(classç±»ç»„ä»¶çš„`Purcomponent`ï¼Œå‡½æ•°å¼ç»„ä»¶çš„`meomo`)åªåœ¨ä¸‹é¢å‡ ç§æƒ…å†µä¸‹æ–¹èƒ½èµ·ä½œç”¨ï¼š
  >
  >  ã€€1ã€å‡è®¾`<Child />`æœ‰è‡ªèº«çš„stateçš„çŠ¶æ€ï¼Œé‚£ä¹ˆåªæœ‰åœ¨è‡ªèº«stateå¯¹è±¡çš„å±æ€§å€¼æ²¡æœ‰åµŒå¥—å±‚ï¼Œå³å±æ€§å€¼éƒ½ä¸ºåŸºæœ¬æ•°æ®ç±»å‹æ—¶ï¼Œæ–¹èƒ½åœ¨setStateçš„æ—¶å€™ï¼Œé¿å…ä¸å¿…è¦çš„çš„é‡å¤æ¸²æŸ“ï¼›
  >
  > ```javascript
  > function Child() {
  >   const [number, changeNumber] = React.useState(1000);
  >   return (
  >     <div>
  >       <span>{number}</span>
  >       <button
  >         type="button"
  >         onClick={() => {
  >           changeNumber(1000);
  >         }}
  >       >
  >         ç‚¹æˆ‘
  >       </button>
  >     </div>
  >   );
  > }
  > 
  > export default React.memo(Child);
  > ```
  >
  > ã€€ï¼’ã€å‡è®¾`<Child />`æ²¡æœ‰è‡ªèº«çŠ¶æ€(ä¸ºäº†æ’é™¤è‡ªèº«stateå¯¹è±¡çš„å±æ€§å€¼æœ‰åµŒå¥—å±‚çš„æƒ…å†µ)ï¼Œä»`<Parent />`ä¼ é€’ç»™`<Child />`çš„propsæ²¡æœ‰åµŒå¥—å±‚ï¼Œå³ä¸ºåŸºæœ¬æ•°æ®ç±»å‹æ—¶ï¼›
  >
  > ```javascript
  > export default function Parent() {
  >   return <Child number={1000} />;
  > }
  > ```
  >
  > ã€€3ã€å‡è®¾`<Child />`æ²¡æœ‰è‡ªèº«çŠ¶æ€ï¼Œä»`<Parent />`ä¼ é€’ç»™`<Child />`çš„propsè™½ç„¶æœ‰åµŒå¥—å±‚ï¼Œå³å¼•ç”¨æ•°æ®ç±»å‹ï¼Œä½†æ˜¯ç›´æ¥æ¥æºäº`<Parent />`çš„stateï¼Œæ²¡æœ‰å»â€æ‰‹åŠ¨åŠ å·¥â€œ
  >
  > ```javascript
  > export default function Parent() {
  >   const [sendVal, setVal] = React.useState({ number: 1000 });
  >   return <Child sendProps={sendVal} />;
  > }
  > ```
  >
  > é™¤å»ä¸Šé¢3ç§æƒ…å†µï¼Œ`shallowCompare`å‡ä¼šå¤±æ•ˆï¼›
  >
  > ```javascript
  > // --------------------è‡ªèº«stateå¯¹è±¡çš„å±æ€§çš„å±æ€§å€¼æœ‰å¼•ç”¨æ•°æ®ç±»å‹-------------------------
  > export default class Child extends React.PureComponent {
  >   state = {
  >     objtype: {
  >       number: 1000,
  >     },
  >   };
  > 
  >   changeNumber = () => {
  >     this.setState({
  >       objtype: {
  >         number: 1000,
  >       },
  >     });
  >   };
  > 
  >   render() {
  >     const { objtype } = this.state;
  >     return (
  >       <div>
  >         <span>{objtype.number}</span>
  >         <button type="button" onClick={this.changeNumber}>
  >           ç‚¹æˆ‘
  >         </button>
  >       </div>
  >     );
  >   }
  > }
  > 
  > // --------------------ä¼ é€’ç»™<Child />çš„props-------------------------
  > export default function Parent() {
  >   return ï¼ˆ
  >     <Child 
  >       sendProps={{number: 1000}} 
  >     />
  >   ï¼‰;
  > }
  > ```
  >
  > 

* å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ shouldComponentUpdate() ä¸­ä½¿ç”¨ä½¿ç”¨ deepCopy å’Œ deepCompare æ¥é¿å…ä¸å¿…è¦çš„ re-render()ï¼Œä½† deepCopyï¼ˆæ·±æ‹·è´ï¼‰ å’Œ deepCompareï¼ˆå¾ªç¯å±‚å±‚é€’å½’æ¯”è¾ƒï¼‰ ä¸€èˆ¬éƒ½æ˜¯éå¸¸è€—æ€§èƒ½çš„ã€‚

* è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ Immutable.jsï¼ŒImmutable.jsçš„å‡ å¤§ç‰¹æ€§è§£å†³ä¸Šé¢è¿™ä¸ªReactæ€§èƒ½é—®é¢˜ï¼ˆImmutable åˆ™æä¾›äº†ç®€æ´é«˜æ•ˆçš„åˆ¤æ–­æ•°æ®æ˜¯å¦å˜åŒ–çš„æ–¹æ³•ï¼Œåªéœ€ === å’Œ is æ¯”è¾ƒï¼ˆæ¯”è¾ƒhashCodeï¼‰å°±èƒ½çŸ¥é“æ˜¯å¦éœ€è¦æ‰§è¡Œ render()ï¼Œè€Œè¿™ä¸ªæ“ä½œå‡ ä¹ 0 æˆæœ¬ï¼Œæ‰€ä»¥å¯ä»¥æå¤§æé«˜æ€§èƒ½ï¼‰ï¼Œå½“ç„¶è¿˜æœ‰ä¸€ç‚¹æ˜¯Immutable.jsæä¾›äº†ä¸°å¯Œçš„Apiï¼Œç»ˆäºå›åˆ°äº†ä¸»çº¿ä¸Š` Immutable.jsåœ¨React/Reduxä¸­çš„åº”ç”¨`ï¼ï¼ï¼


## Â§ <a name="Immutable-apply">6.Immutable.jsåœ¨React/Reduxä¸­çš„åº”ç”¨</a>
#### Â§<a name="use-boundary"> 6.1ä½¿ç”¨ immutable çš„è¾¹ç•Œæ€§é—®é¢˜</a>
> åº”ç”¨Immutable.jsäºReact/Reduxä¸­ï¼Œæˆ‘ä»¬æœ‰å¿…è¦æ¥åˆ’åˆ†ä¸€ä¸‹è¾¹ç•Œï¼Œå“ªäº›æ•°æ®éœ€è¦ä½¿ç”¨ä¸å¯å˜æ•°æ®ï¼Œå“ªäº›æ•°æ®è¦ä½¿ç”¨åŸç”Ÿjsæ•°æ®ç»“æ„ï¼Œå“ªäº›åœ°æ–¹éœ€è¦åšäº’ç›¸è½¬æ¢ï¼›

![immutableBoundary](assets/immutableBoundary.png)

* åœ¨reduxä¸­ï¼Œå…¨å±€stateå¿…é¡»æ˜¯immutableçš„ï¼Œè¿™ç‚¹æ¯‹åº¸ç½®ç–‘æ˜¯æˆ‘ä»¬ä½¿ç”¨immutableæ¥ä¼˜åŒ–reduxçš„æ ¸å¿ƒï¼›
* ç»„ä»¶propsæ˜¯é€šè¿‡reduxçš„connectä»stateä¸­è·å¾—çš„ï¼Œå¹¶ä¸”å¼•å…¥immutableJSçš„å¦ä¸€ä¸ªç›®çš„æ˜¯å‡å°‘ç»„ä»¶shouldComponentUpdateä¸­ä¸å¿…è¦æ¸²æŸ“ï¼ŒshouldComponentUpdateä¸­æ¯”å¯¹çš„æ˜¯propsï¼Œå¦‚æœpropsæ˜¯åŸç”ŸJSå°±å¤±å»äº†ä¼˜åŒ–çš„æ„ä¹‰ï¼›
* ç»„ä»¶å†…éƒ¨stateå¦‚æœéœ€è¦æäº¤åˆ°storeçš„ï¼Œå¿…é¡»æ˜¯immutableï¼Œå¦åˆ™ä¸å¼ºåˆ¶ï¼›
* ä»è§†å›¾å±‚å‘åŒæ­¥å’Œå¼‚æ­¥ action å‘é€çš„æ•°æ®ï¼ˆA/Bï¼‰ï¼Œå¿…é¡»æ˜¯ immutable çš„ï¼›
* Action æäº¤ç»™ reducer çš„æ•°æ®ï¼ˆC/Dï¼‰ï¼Œå¿…é¡»æ˜¯ immutable çš„ï¼›
* reducerä¸­æœ€ç»ˆå¤„ç†state(E)å¿…é¡»æ˜¯ä»¥immutableçš„å½¢å¼å¤„ç†å¹¶è¿”å›ï¼›
* ä¸æœåŠ¡ç«¯ajaxäº¤äº’ä¸­è¿”å›çš„callbackç»Ÿä¸€å°è£…ï¼Œç¬¬ä¸€æ—¶é—´è½¬æ¢æˆimmutableæ•°æ®ï¼›

è¿™æ ·ä¼¼ä¹çœ‹èµ·æ¥ï¼Œæ‰€æœ‰åœ°æ–¹éƒ½æ˜¯ immutable çš„ï¼Œé™¤å¼€å¼‚æ­¥ action å’ŒæœåŠ¡å™¨çš„äº¤äº’æ˜¯ JSD ï¼ˆFï¼‰ã€‚
æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬è¦æ±‚ï¼Œé™¤äº†å‘æœåŠ¡ç«¯å‘é€æ•°æ®è¯·æ±‚çš„æ—¶å€™ï¼Œå…¶ä»–ä½ç½®ï¼Œä¸å…è®¸å‡ºç°`toJS`çš„ä»£ç ã€‚
è€Œæ¥æ”¶åˆ°æœåŠ¡ç«¯çš„æ•°æ®åï¼Œåœ¨æµè½¬å…¥å…¨å±€ state ä¹‹å‰ï¼Œç»Ÿä¸€è½¬åŒ–ä¸º immutable æ•°æ®ã€‚

ä¸ºä»€ä¹ˆè¦åšè¿™ç§ç»Ÿä¸€å‘¢ï¼Ÿæ˜¯å› ä¸ºï¼š
* é¿å… JSDï¼ˆjså¯¹è±¡ï¼‰ å’Œ immutable å¯¹è±¡çš„æ··ç”¨å¯¼è‡´å‡ºé”™ï¼ˆå¯èƒ½åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œæ··ç”¨ jså¯¹è±¡ å’Œ immutable å¯¹è±¡ï¼Œä¼šè®©coderè‡ªå·±éƒ½ä¸æ¸…æ¥šä¸€ä¸ªå˜é‡ä¸­å­˜å‚¨çš„åˆ°åº•æ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®ï¼‰ï¼›
* ç»Ÿä¸€JSDï¼ˆjså¯¹è±¡ï¼‰å’Œ immutableå¯¹è±¡ çš„è½¬åŒ–è·¯å¾„ã€‚æ¯”å¦‚ä½ åœ¨å±€éƒ¨ state é‡Œä¸ä½¿ç”¨ immutableï¼Œä½†æ˜¯è¿™äº›å±€éƒ¨çš„ state å¾ˆå¯èƒ½è¢«ç”¨æ¥é€šè¿‡å¼‚æ­¥ action æäº¤çš„æœåŠ¡ç«¯ï¼Œè¿™æ ·åœ¨æ•°æ®æµé‡Œå°±ä¼šåŒæ—¶å­˜åœ¨ JSD å’Œ immutableï¼Œè¿™å¯¹äºä»£ç çš„ç»´æŠ¤æ€§æ˜¯ä¸€ç§ç¾éš¾ã€‚

æœ‰çš„äººè¯´ï¼Œæˆ‘è§‰å¾—æˆæœ¬å¤ªå¤§ï¼Œæˆ‘åªæƒ³åœ¨ reducer é‡Œå±€éƒ¨ä½¿ç”¨ immutableï¼Œäºæ˜¯ä»£ç å˜æˆäº†è¿™æ ·ï¼š

```javascript
export default function indexReducer(state, action) {
    switch (action.type) {
    case RECEIVE_MENU:
        state = immutable.fromJS(state); //è½¬æˆimmutableå¯¹è±¡
        state = state.merge({a:1});
        return state.toJS() //è½¬å›åŸç”Ÿjs
    }  
}
```

è¿™æ ·çœ‹èµ·æ¥åªæ˜¯è®© immutable ä¾µå…¥åˆ° reducer ä¸­ï¼Œå…¶å®å´æ˜¯å¾—ä¸å¿å¤±çš„ã€‚åŸå› æœ‰äºŒï¼š
* fromJS() å’Œ toJS() æ˜¯æ·±å±‚çš„äº’è½¬immutableå¯¹è±¡å’ŒåŸç”Ÿå¯¹è±¡ï¼Œæ€§èƒ½å¼€é”€å¤§ï¼Œå°½é‡ä¸è¦ä½¿ç”¨ï¼›
* ç»„ä»¶ä¸­propså’Œstateè¿˜æ˜¯åŸç”Ÿjsï¼ŒshouldComponentUpdateä»ç„¶æ— æ³•åšåˆ©ç”¨immutablejsçš„ä¼˜åŠ¿åšæ·±åº¦æ¯”è¾ƒï¼›

#### Â§<a name="rebuld-shouldComponentUpdate"> 6.2ç”¨Immutable.jsæ”¹é€ shouldComponentUpdate</a>
shouldComponentUpdateå…·ä½“æ€ä¹ˆå°è£…æœ‰å¾ˆå¤šç§åŠæ³•ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰æ‹©äº†å°è£…ä¸€å±‚componentçš„åŸºç±»ï¼Œåœ¨åŸºç±»ä¸­å»ç»Ÿä¸€å¤„ç†shouldComponentUpdateï¼Œç»„ä»¶ä¸­ç›´æ¥ç»§æ‰¿åŸºç±»çš„æ–¹å¼
> æ³¨æ„ï¼šReact ä¸­è§„å®š state å’Œ props åªèƒ½æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œæ‰€ä»¥æ¯”è¾ƒæ—¶è¦æ¯”è¾ƒå¯¹è±¡çš„ value

```javascript
import React from 'react';
import {is} from 'immutable';

class BaseComponent extends React.Component {
    constructor(props, context, updater) {
        super(props, context, updater);
    }

    shouldComponentUpdate(nextProps = {}, nextState = {}) {
    const thisProps = this.props || {};
    const thisState = this.state || {};
    let isEqual = false;
    if (
      Object.keys(thisProps).length !== Object.keys(nextProps).length ||
      Object.keys(thisState).length !== Object.keys(nextState).length
    ) {
      isEqual = true;
    }

    Object.keys(nextProps).forEach(key => {
      if (!is(thisProps[key], nextProps[key])) {
        isEqual = true;
      }
    });

    Object.keys(nextState).forEach(key => {
      if (!is(thisState[key], nextState[key])) {
        isEqual = true;
      }
    });

    return isEqual;
  }
}

export default BaseComponent;
```
ç»„ä»¶ä¸­å¦‚æœéœ€è¦ä½¿ç”¨ç»Ÿä¸€å°è£…çš„shouldComponentUpdateï¼Œåˆ™ç›´æ¥ç»§æ‰¿åŸºç±»

```javascript
import BaseComponent from './BaseComponent';
class Menu extends BaseComponent {
    constructor(props) {
        super(props);
    }
    â€¦â€¦â€¦â€¦
}
```
å½“ç„¶å¦‚æœç»„ä»¶ä¸æƒ³ä½¿ç”¨å°è£…çš„æ–¹æ³•ï¼Œé‚£ç›´æ¥åœ¨è¯¥ç»„ä»¶ä¸­é‡å†™shouldComponentUpdateå°±è¡Œäº†

è¿˜æ˜¯[5.4PureComponent](#PureComponent)ä¸­çš„ä¾‹å­ï¼Œç„¶åæˆ‘ä»¬ç”¨æ”¹é€ åçš„shouldComponentUpdateæ¥éªŒè¯ä¸‹ï¼š
```javascript
//çˆ¶ç»„ä»¶
import {fromJS,Map} from "immutable";

class PageOne extends React.Component{
    constructor(props){
        super(props);
        this.state={
            $state:fromJS({
                count:1,
                person:{
                    name:"å°ç™½",
                    age:20
                }
            })
        };
        this.increaseTimes=this.increaseTimes.bind(this);
    }
    increaseTimes(){
        this.setState(({$state})=>({
          $state:mergeDeep($state,{
                count:$state.get('count')+1,
                person:{
                    name:"å°ç™½",
                    age:21
                }
              })
        }))
    }
    render(){
        const {$state}=this.state;
        return(
            <ul className="pageOne">
                <li>
                    <span>æ›´æ”¹æ¬¡æ•°ï¼šæ›´æ”¹+{$state.get("count")}</span>
                    <button onClick={this.increaseTimes}>ç‚¹æˆ‘</button>
                </li>
                <Person $person={$state.get("person")}/>
            </ul>
        )
    }
}
```
```javascript
//å­ç»„ä»¶
import BaseComponent from "../baseComponent/baseComponent.jsx";

class Person extends BaseComponent{
    constructor(props){
        super(props)
    }
    render(){
        console.log("æˆ‘re-renderäº†");
        const {$person}=this.props;
        return(
            <li>
                åå­—æ˜¯ï¼š{$person.get("name")}ï¼Œ
                å¹´é¾„æ˜¯ï¼š{$person.get("age")}
            </li>
        )
    }
}
```

![immutableUse](assets/immutableUse.png)

å¯ä»¥æ˜æ˜¾çœ‹åˆ°ï¼Œä»…é‡æ–°æ¸²æŸ“äº†ageç”±20æ›´æ”¹åˆ°21è¿™ä¸€æ¬¡ï¼

ä½¿ç”¨ Immutable åï¼Œå¦‚ä¸‹å›¾ï¼Œå½“çº¢è‰²èŠ‚ç‚¹çš„ state å˜åŒ–åï¼Œä¸ä¼šå†æ¸²æŸ“æ ‘ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè€Œæ˜¯åªæ¸²æŸ“å›¾ä¸­ç»¿è‰²çš„éƒ¨åˆ†ï¼š

![immutableReRender](assets/immutableReRender.png)


ä½ ä¹Ÿå¯ä»¥ä¸ç”¨è‡ªå·±å»æ‰‹åŠ¨å°è£…shouldComponentUpdateæˆ–è€…åœ¨ç»„ä»¶ä¸­é‡å†™ï¼Œå¯ä»¥ç”¨å°è£…å¥½äº†çš„[react-immutable-render-mixin](https://github.com/jurassix/react-immutable-render-mixin)è¿™ä¸ªåº“å°±å¥½äº†ï¼Œè¿˜å¯ä»¥ç”¨es7çš„è£…é¥°å™¨ï¼Œå“ˆå“ˆå“ˆ

```javascript
import React from "react";
import {immutableRenderDecorator} from "react-immutable-render-mixin";

@immutableRenderDecorator
class Person extends React.Component{
    constructor(props){
        super(props)
    }
    render(){
        console.log("æˆ‘re-renderäº†");
        let {$person}=this.props;
        return(
            <li>
                åå­—æ˜¯ï¼š{$person.get("name")}ï¼Œ
                å¹´é¾„æ˜¯ï¼š{$person.get("age")}
            </li>
        )
    }
```
å’Œä¸Šé¢çš„æ•ˆæœæ˜¯ä¸€æ ·ä¸€æ ·çš„

å¦å¤–åœ¨åº”ç”¨immutable.jsäºReactçš„é¡¹ç›®ä¸­ ï¼Œç»„ä»¶ props çš„æ ¡éªŒä¹Ÿéœ€è¦ä¸æ—¶ä¿±è¿›ï¼Œä½¿ç”¨ immutable ç±»å‹æ ¡éªŒï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬ import ä¸“é—¨é’ˆå¯¹ immutable ç±»å‹è¿›è¡Œæ ¡éªŒçš„åº“ï¼š[react-immutable-proptypes](https://github.com/HurricaneJames/react-immutable-proptypes)ï¼Œä½¿ç”¨æ–¹æ³•åŸºæœ¬ä¸Šå’Œæ™®é€šçš„ PropTypes ä¸€è‡´ï¼š
```javascript
import React from "react";
import ImmutablePropTypes from "react-immutable-proptypes";
import BaseComponent from "../baseComponent/baseComponent.jsx";

immutableRenderDecorator
class Person extends React.Component{
   static propTypes = {
        $person:ImmutablePropTypes.map
    };
    constructor(props){
        super(props)
    }
    render(){
        console.log("æˆ‘re-renderäº†");
        const {$person}=this.props;
        return(
            <li>
                åå­—æ˜¯ï¼š{$person.get("name")}ï¼Œ
                å¹´é¾„æ˜¯ï¼š{$person.get("age")}
            </li>
        )
    }
```

#### Â§<a name="with-redux"> 6.3ä¸Reduxæ­é…ä½¿ç”¨</a>
Redux æ˜¯ç›®å‰æµè¡Œçš„ Flux è¡ç”Ÿåº“ã€‚å®ƒç®€åŒ–äº† Flux ä¸­å¤šä¸ª Store çš„æ¦‚å¿µï¼Œåªæœ‰ä¸€ä¸ª Storeï¼Œæ•°æ®æ“ä½œé€šè¿‡ Reducer ä¸­å®ç°ï¼›åŒæ—¶å®ƒæä¾›æ›´ç®€æ´å’Œæ¸…æ™°çš„å•å‘æ•°æ®æµï¼ˆView -> Action -> Middleware -> Reducerï¼‰ï¼Œä¹Ÿæ›´æ˜“äºå¼€å‘åŒæ„åº”ç”¨ã€‚ç›®å‰å·²ç»åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­å¤§è§„æ¨¡ä½¿ç”¨ã€‚

ä½¿ç”¨Reduxçš„æ³¨æ„ç‚¹ï¼š

* é¿å…ç»„ä»¶è®¢é˜…æ— å…³çš„ReduxçŠ¶æ€ï¼Œé¿å…ä¸å¿…è¦çš„æ¸²æŸ“ï¼›
* `React-redux`æä¾›çš„`connect`æ–¹æ³•æœ‰ä¸€å±‚shallowCompareï¼Œå¦‚æœæƒ³è®©shallowCompareèµ·ä½œç”¨ï¼Œç»„ä»¶è®¢é˜…çš„ReduxçŠ¶æ€å€¼ä¹ŸåŒæ ·åº”è¯¥æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¸è¦åœ¨mapStateToPropsæ„å»ºæ–°çš„å¯¹è±¡ï¼›

è€Œä¸” Flux å¹¶æ²¡æœ‰é™å®š Store ä¸­æ•°æ®çš„ç±»å‹ï¼Œä½¿ç”¨ Immutable éå¸¸ç®€å•ã€‚

æŒ‰ç…§ Redux çš„å·¥ä½œæµï¼Œæˆ‘ä»¬ä»åˆ›å»º store å¼€å§‹ã€‚Redux çš„ createStore å¯ä»¥ä¼ é€’å¤šä¸ªå‚æ•°ï¼Œå‰ä¸¤ä¸ªæ˜¯ï¼š reducers å’Œ initialStateã€‚

reducers æˆ‘ä»¬ç”¨ redux-immutable æä¾›çš„ combineReducers æ¥å¤„ç†ï¼Œä»–å¯ä»¥å°† immutable ç±»å‹çš„å…¨å±€ state è¿›è¡Œåˆ†è€Œæ²»ä¹‹ï¼š
```javascript
import {combineReducers} from "redux-immutable";

const rootReducer = combineReducers({
	$left: leftReducer,
	$right: rightReducer
});
```

å½“ç„¶ initialState éœ€è¦æ˜¯ immutable çš„ï¼š
```javascript
const initialState = Immutable.Map();
const store = createStore(rootReducer, initialState);
```
å¦‚æœä½ ä¸ä¼ é€’ initialStateï¼Œredux-immutableä¹Ÿä¼šå¸®åŠ©ä½ åœ¨ store åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé€šè¿‡æ¯ä¸ªå­ reducer çš„åˆå§‹å€¼æ¥æ„å»ºä¸€ä¸ªå…¨å±€ Map ä½œä¸ºå…¨å±€ stateã€‚å½“ç„¶ï¼Œè¿™è¦æ±‚ä½ çš„æ¯ä¸ªå­ reducer çš„é»˜è®¤åˆå§‹å€¼æ˜¯ immutableçš„ã€‚

>**&sect;å‚è€ƒåœ°å€ï¼š**
>* [ å‰ç«¯é«˜è´¨é‡çŸ¥è¯†(ä¸€)-JSå†…å­˜ç©ºé—´è¯¦ç»†å›¾è§£](https://blog.csdn.net/pingfan592/article/details/55189622)
>* [javascripeä¸­æ·±åº¦æ‹·è´ä½¿ç”¨JSON.stringifyå’Œparseå¥½ä¹ˆ?](https://www.zhihu.com/question/52965788)
>* [ã€JSã€‘æ·±æ‹·è´ vs æµ…æ‹·è´](https://zhuanlan.zhihu.com/p/29048537)
>* [å…³äºJavaScriptçš„æµ…æ‹·è´å’Œæ·±æ‹·è´](http://www.cnblogs.com/Chen-XiaoJun/p/6217373.html)
>* [jså†…å­˜å †æ ˆï¼Œé€’å½’åŸç†ä»¥åŠæµ…æ‹·è´å’Œæ·±æ‹·è´çš„ç†è§£](https://zhuanlan.zhihu.com/p/24996104)
>* [å‰‘æŒ‡Offerâ€”â€”Trieæ ‘(å­—å…¸æ ‘)](https://blog.csdn.net/sunhuaqiang1/article/details/52463257)
>* [Trieå®è·µï¼šä¸€ç§æ¯”å“ˆå¸Œè¡¨æ›´å¿«çš„æ•°æ®ç»“æ„](https://blog.csdn.net/stevenkylelee/article/details/38343985)
>* [ç²¾è¯» Immutable ç»“æ„å…±äº«](https://github.com/ascoders/blog/issues/20)
>* [immutableå…¥å‘æŒ‡å—](http://www.aliued.com/?p=4175)
>* [Immutable.js ä»¥åŠåœ¨ react+redux é¡¹ç›®ä¸­çš„å®è·µ](https://juejin.im/post/5948985ea0bb9f006bed7472?utm_source=tuicool&utm_medium=referral)
>* [Immutable è¯¦è§£åŠ React ä¸­å®è·µ](https://github.com/camsong/blog/issues/3)
>* [åœ¨react/reduxä¸­ä½¿ç”¨Immutable](http://www.mamicode.com/info-detail-2201824.html)
>* [ä½¿ç”¨immutableä¼˜åŒ–React](https://segmentfault.com/a/1190000010438089)
>* [Reactæ€§èƒ½ä¼˜åŒ–æ€»ç»“](https://segmentfault.com/a/1190000007811296)
>* [èµ¢è´¢å¯Œï¼ˆå¾®ä¿¡ç‰ˆï¼‰ç›®å‰å­˜åœ¨çš„æ€§èƒ½é—®é¢˜--reacæ€§èƒ½é—®é¢˜ ](https://github.com/SpringLIAO/blog/issues/8)
>* [Reactä¸­keyçš„å¿…è¦æ€§ä¸ä½¿ç”¨](https://www.jianshu.com/p/0218ff2591ec)
>* [React.PureComponent é…ä¸Š ImmutableJS æ‰æ›´æœ‰æ„ä¹‰](https://www.timefly.cn/react-purecomponent-with-immutablejs/)
>* [reactå¦‚ä½•æ€§èƒ½è¾¾åˆ°æœ€å¤§åŒ–(å‰ä¼ )ï¼Œæš¨reactä¸ºå•¥éå¾—ä½¿ç”¨immutable.js](https://segmentfault.com/a/1190000004290333)
>* [å¦‚ä½•ç”¨React+Redux+ImmutableJSè¿›è¡ŒSPAå¼€å‘](http://yunlaiwu.github.io/blog/2016/12/01/react+redux+immutablejs/)
>* [React äº‹ä»¶ç»‘å®š this](https://github.com/nanyang24/blog/issues/75)
>* [JavaScript æ•°æ®ç±»å‹å’Œæ•°æ®ç»“æ„](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures)
>* [å” å¨ä¸€ä¸‹jså¯¹è±¡ä¸å“ˆå¸Œè¡¨é‚£äº›äº‹](https://segmentfault.com/a/1190000007692754)
>* [JavaScript å¯¹è±¡ä¸ Hash è¡¨](https://lz5z.com/JavaScript-Object-Hash/)
>* [å…³äºreact, redux, react-reduxå’Œreselectçš„ä¸€äº›æ€è€ƒ](https://zhuanlan.zhihu.com/p/33985606)

